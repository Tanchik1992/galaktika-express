//------------------------------------------------------------------------------
//                                                      (c) корпорация Галактика
// Галактика 5.85 - Векселя и кредиты
// Печать отчетов о движении векселей и ценных бумаг
//------------------------------------------------------------------------------

#doc
Печать отчетов о движении векселей и ценных бумаг
#end

.Form 'VeksMove'
.Hide
.Fields
Сортировка_по_дате_получения : boolean
Субъект_отчета_имен
Субъект_отчета_родит
Субъект_отчета_дат
Субъект_отчета_творит
Субъект_отчета_предл
UserDeskRep_NRec
Собственная_организация_nRec : comp
Собственная_организации_наим
Собственная_организации_ОКПО
ifNal : Boolean
Валюта_реестра
Валюта_отчетов_nRec : comp
Валюта_отчетов
Валюта_НДЕ
Формат_сумм
Формат_кол
Группировка
Сортировка
!---------------- FilterVeks
Фильтр
!---------------- GruppaVeks
Head_TempDescr_NRec
Head_TempDescr_TableCode : word // код таблицы по которой постоена данная группировка
Head_TempDescr_CRecKat   : comp // номер записи в таблице по которой построена группировка
Ветка
Итого_верх_приход_НДЕ
Итого_верх_приход_ВО
Итого_верх_расход_НДЕ
Итого_верх_расход_ВО
Итого_верх_номинал_НДЕ
Итого_верх_номинал_ВО
Итого_верх_номинал_НДЕ_получение //учитывается только для операции поступления (или передачи - если поступления не было)
Итого_верх_номинал_ВО_получение  //учитывается только для операции поступления (или передачи - если поступления не было)
Итого_верх_наличие_НДЕ
Итого_верх_наличие_ВО
Итого_верх_кол
Итого_верх_кол_получение        //учитывается только для операции поступления (или передачи - если поступления не было)
Валюта_верх
Итого_верх_оплата_приход_НДЕ
Итого_верх_оплата_приход_ВО
Итого_верх_оплата_расход_НДЕ
Итого_верх_оплата_расход_ВО
Итого_верх_оплата_наличие_НДЕ
Итого_верх_оплата_наличие_ВО
!---------------- NameVeks
Body_TempDescr_NRec
Body_Tobot_NRec : comp
Номер_по_порядку
Flag1 : Word
Veksl_NRec : comp
Серия
Номер
Конечный_номер
Бланк
Количество
Дата_выписки : Date
Дата_закрытия : Date
Дата_оборота : Date
Вид_nRec : comp
Вид
Статус_nRec : comp
Статус_наим
Статус_символ
Статус_код
Условие_nRec
Период
Условие_наим
BInDate       //если True, то план предъявления в дату, иначе - не ранее даты
Плановая_дата_предъявления : date
f_Veksl_cPlat_nRec : comp
f_Veksl_cPlat
f_Veksl_cPl_nRec : comp
f_Veksl_cPl
f_Veksl_cPol_nRec : comp
f_Veksl_cPol
f_Veksl_cPlh_nRec : comp
f_Veksl_cPlh
f_Veksl_cPolh_nRec : comp
f_Veksl_cPolh
Место_выдачи
Место_платежа
Процент_годовых
Npp
Сумма_НДЕ
Сумма_вал
Сумма_гаш_НДЕ
Сумма_гаш_вал
Валюта_документа_nRec : comp
Валюта_документа

AppVeks_NRec
Дата_акта : Date
Номер_акта
AppVeks_TiDk
Тип_акта
Контрагент_nRec : comp
Контрагент
Кто_выписал_nRec : comp
Кто_выписал
Примечание_1
Примечание_2
Примечание_3
Статус_АПП_nRec : comp
Статус_АПП_наим
Статус_АПП_наим_кратко
Статус_АПП_PrUm : Word
Статус_АПП_Prizn : Word
Статус_АПП_Koeff : Double
BaseDoc_NRec : Comp
ДО_номер
ДО_дата : Date
Dogovor_NRec : Comp
Договор_номер
Договор_дата : Date
ТХО_АПП_nRec : comp
ТХО_АПП_Код
ТХО_АПП_Наим1
ТХО_АПП_Наим2
ТХО_АПП_Наим3
ТХО_АПП_Наим4
SoglVeks_NRec : Comp
ВексСогл_номер
ВексСогл_дата : Date

SpApp_NRec
SpApp_Npp
Наличие_налоговой_справки : boolean
Количество_по_акту
Количество_по_акту_получение   //учитывается только для операции поступления (или передачи - если поступления не было)
Приход_факт_НДЕ
Приход_факт_вал
Приход_факт_ВО
Расход_факт_НДЕ
Расход_факт_вал
Расход_факт_ВО
Номинал_НДЕ
Номинал_вал
Номинал_ВО
Номинал_НДЕ_получение  //учитывается только для операции поступления (или передачи - если поступления не было)
Номинал_вал_получение  //учитывается только для операции поступления (или передачи - если поступления не было)
Номинал_ВО_получение   //учитывается только для операции поступления (или передачи - если поступления не было)
Наличие_НДЕ
Наличие_вал
Наличие_ВО
Валюта_строка
Оплата_приход_НДЕ
Оплата_приход_вал
Оплата_приход_ВО
Оплата_расход_НДЕ
Оплата_расход_вал
Оплата_расход_ВО
Оплата_наличие_НДЕ
Оплата_наличие_вал
Оплата_наличие_ВО
!---------------- ItogVeks
Tail_TempDescr_NRec
Tail_TempDescr_TableCode : word // код таблицы по которой постоена данная группировка
Tail_TempDescr_CRecKat   : comp // номер записи в таблице по которой построена группировка
Итого
Итого_приход_НДЕ
Итого_приход_ВО
Итого_расход_НДЕ
Итого_расход_ВО
Итого_номинал_НДЕ
Итого_номинал_ВО
Итого_номинал_НДЕ_получение //учитывается только для операции поступления (или передачи - если поступления не было)
Итого_номинал_ВО_получение  //учитывается только для операции поступления (или передачи - если поступления не было)
Итого_наличие_НДЕ
Итого_наличие_ВО
Итого_кол
Итого_кол_получение         //учитывается только для операции поступления (или передачи - если поступления не было)
Валюта_низ
Итого_оплата_приход_НДЕ
Итого_оплата_приход_ВО
Итого_оплата_расход_НДЕ
Итого_оплата_расход_ВО
Итого_оплата_наличие_НДЕ
Итого_оплата_наличие_ВО
.EndFields
^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^
.{ CheckEnter FilterVeks2
^
.}
.{
.{ CheckEnter GruppaVeks2
^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^
.}
.{ CheckEnter NameVeks2
^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^
^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^
^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^
^ ^
.}
.{ CheckEnter ItogVeks2
^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^
.}
.}
.EndForm

!=============================================================================
.LinkForm 'VeksMove_01' Prototype is 'VeksMove'
!=============================================================================
.NameInList 'Книга учета векселей (ценных бумаг)'
.Group 'Ведомости движения векселей и ценных бумаг'
.p 60
.defo landscape
.Var
  NppPost      : comp;

  Curr_In      : boolean;   //тек.строка - получение
  Prev_In      : boolean;   //предыдущая строка - получение
  Prev_Another : boolean;   //предыдущая строка - по другому векселю
  Is_First     : boolean;
  Prev_nRec    : comp;
  Print_Prev   : boolean;
  Print_Curr   : boolean;
  Last_Printed : boolean;
  Print_Leafs  : boolean;

  //для сохранения строки
  Prev_Npp                : string;
  Prev_f_Veksl_cPlat      : string;
  Prev_Количество_по_акту : string;
  Prev_Номер              : string;
  Prev_Серия              : string;
  Prev_Процент_годовых    : string;
  Prev_Номинал            : string;
  Prev_Валюта_строка      : string;
  Prev_Приход_Наличие     : string;
  Prev_Расход_факт        : string;
  Prev_Дата_акта_In       : string;
  Prev_Контрагент_In      : string;
  Prev_Дата_акта_Out      : string;
  Prev_Контрагент_Out     : string;

  tmp_Already_Printed_Npp : string; //чтобы не дублировались строки

.EndVar
.Fields
CommonFormHeader
UpCase(Субъект_отчета_имен)
Валюта_реестра
Группировка
Сортировка
!---------------- FilterVeks
Фильтр
!---------------- GruppaVeks
Ветка
DoubleToStr( Double(Итого_верх_кол_получение), Формат_кол )
DoubleToStr( if( Double(Итого_верх_номинал_ВО_получение)!=0,
                 Double(Итого_верх_номинал_ВО_получение),
                 Double(Итого_верх_номинал_НДЕ_получение)), Формат_сумм )
Валюта_верх
if ( ifNal,
     DoubleToStr( if( Double(Итого_верх_приход_ВО)  + Double(Итого_верх_наличие_ВО) != 0,
                      Double(Итого_верх_приход_ВО)  + Double(Итого_верх_наличие_ВО),
                      Double(Итого_верх_приход_НДЕ) + Double(Итого_верх_наличие_НДЕ)), Формат_сумм),
     DoubleToStr( if( Double(Итого_верх_приход_ВО) != 0,
                      Double(Итого_верх_приход_ВО),
                      Double(Итого_верх_приход_НДЕ)),Формат_сумм))
DoubleToStr( if( Double(Итого_верх_расход_ВО) != 0,
                 Double(Итого_верх_расход_ВО),
                 Double(Итого_верх_расход_НДЕ)
               ), Формат_сумм )
!---------------- NameVeks
Prev_Npp
Prev_f_Veksl_cPlat
Prev_Количество_по_акту
Prev_Номер
Prev_Серия
Prev_Процент_годовых
Prev_Номинал
Prev_Валюта_строка
Prev_Приход_Наличие
Prev_Расход_факт
Prev_Дата_акта_In
Prev_Контрагент_In
Prev_Дата_акта_Out
Prev_Контрагент_Out

if (Double(Номинал_НДЕ_получение)!=0,String(NppPost),'')
f_Veksl_cPlat
DoubleToStr( Double(Количество_по_акту), Формат_кол )
Номер
Серия
Процент_годовых
DoubleToStr( if( Double(Номинал_вал) != 0,
                 Double(Номинал_вал),
                 Double(Номинал_НДЕ)), Формат_сумм )
Валюта_строка
if( Flag1 != 1,
    DoubleToStr( if( Double(Приход_факт_вал) != 0,
                     Double(Приход_факт_вал),
                     Double(Приход_факт_НДЕ)), Формат_сумм),
    DoubleToStr( if( Double(Наличие_вал) != 0,
                     Double(Наличие_вал),
                     Double(Наличие_НДЕ)), Формат_сумм))
DoubleToStr( if( Double(Расход_факт_вал) != 0,
                 Double(Расход_факт_вал),
                 Double(Расход_факт_НДЕ)), Формат_сумм )
if (((AppVeks_TiDk='82')or(AppVeks_TiDk='84')or(AppVeks_TiDk='86')or(AppVeks_TiDk='88')),
    if (LongInt(Дата_акта)<>0,DateToStr(Дата_акта, 'DD/MM/YYYY'),''),'')
if (((AppVeks_TiDk='82')or(AppVeks_TiDk='84')or(AppVeks_TiDk='86')or(AppVeks_TiDk='88')),Контрагент,'')
if (((AppVeks_TiDk='81')or(AppVeks_TiDk='83')or(AppVeks_TiDk='85')or(AppVeks_TiDk='87')),
    if (LongInt(Дата_акта)<>0,DateToStr(Дата_акта, 'DD/MM/YYYY'),''),'')
if (((AppVeks_TiDk='81')or(AppVeks_TiDk='83')or(AppVeks_TiDk='85')or(AppVeks_TiDk='87')),Контрагент,'')

!------------ not Last_Printed
Prev_Npp
Prev_f_Veksl_cPlat
Prev_Количество_по_акту
Prev_Номер
Prev_Серия
Prev_Процент_годовых
Prev_Номинал
Prev_Валюта_строка
Prev_Приход_Наличие
Prev_Расход_факт
Prev_Дата_акта_In
Prev_Контрагент_In
Prev_Дата_акта_Out
Prev_Контрагент_Out

!---------------- ItogVeks
Итого
DoubleToStr( Double(Итого_кол_получение), Формат_кол )
DoubleToStr( if( Double(Итого_номинал_ВО_получение) != 0,
                 Double(Итого_номинал_ВО_получение),
                 Double(Итого_номинал_НДЕ_получение)), Формат_сумм )
Валюта_низ
if( ifNal,
    DoubleToStr( if( Double(Итого_приход_ВО)  + Double(Итого_наличие_ВО) != 0,
                     Double(Итого_приход_ВО)  + Double(Итого_наличие_ВО),
                     Double(Итого_приход_НДЕ) + Double(Итого_наличие_НДЕ)), Формат_сумм ),
    DoubleToStr( if( Double(Итого_приход_ВО) != 0,
                     Double(Итого_приход_ВО),
                     Double(Итого_приход_НДЕ)), Формат_сумм )
  )
DoubleToStr( if( Double(Итого_расход_ВО) != 0,
                 Double(Итого_расход_ВО),
                 Double(Итого_расход_НДЕ)), Формат_сумм )
.EndFields
 Ш.[h
                                                                                                                                                                                                                       Лист @Np@
.]h
.procedure Save_Curr_Data(Save_Both:boolean);
begin
  if (not Save_Both)
  {
    Prev_Npp                := if (Double(Номинал_НДЕ_получение)!=0,String(NppPost),'');
    Prev_f_Veksl_cPlat      := f_Veksl_cPlat;
    Prev_Количество_по_акту := DoubleToStr( Double(Количество_по_акту), Формат_кол );
    Prev_Номер              := Номер;
    Prev_Серия              := Серия;
    Prev_Процент_годовых    := Процент_годовых;
    Prev_Номинал            := DoubleToStr( if( Double(Номинал_вал) != 0,
                                                Double(Номинал_вал),
                                                Double(Номинал_НДЕ)), Формат_сумм );
    Prev_Валюта_строка      := Валюта_строка;
    Prev_Приход_Наличие     := if( Flag1 != 1,
                                 DoubleToStr( if( Double(Приход_факт_вал) != 0,
                                                  Double(Приход_факт_вал),
                                                  Double(Приход_факт_НДЕ)), Формат_сумм),
                                 DoubleToStr( if( Double(Наличие_вал) != 0,
                                                  Double(Наличие_вал),
                                                  Double(Наличие_НДЕ)), Формат_сумм));
    Prev_Дата_акта_In       := if (LongInt(Дата_акта)<>0,DateToStr(Дата_акта, 'DD/MM/YYYY'),'');
    Prev_Контрагент_In      := Контрагент;

    Prev_Расход_факт        := DoubleToStr(0, Формат_сумм);
    Prev_Дата_акта_Out      := '';
    Prev_Контрагент_Out     := '';
  }

  if Save_Both
  {
    Prev_Расход_факт        := DoubleToStr( if( Double(Расход_факт_вал) != 0,
                                                Double(Расход_факт_вал),
                                                Double(Расход_факт_НДЕ)), Формат_сумм );
    Prev_Дата_акта_Out      := if (LongInt(Дата_акта)<>0,DateToStr(Дата_акта, 'DD/MM/YYYY'),'');
    Prev_Контрагент_Out     := Контрагент;
  }
end.
.begin
  NppPost:=0;
  Is_First := True;
  Last_Printed := False;
  Print_Leafs := False;
  tmp_Already_Printed_Npp := '';
  if not Сортировка_по_дате_получения
    Message(''#3'Не установлена сортировка ни по'+
         ''#13#3'дате получения, ни по порядку АПП.'+
         ''#13#3'Желательна установка этих сортировок.');
end.
^

                                  КНИГА УЧЕТА ЦЕННЫХ БУМАГ (^)

Валюта:               ^
Группировка:          ^
Сортировка:           ^
Фильтры:
.{ CheckEnter FilterVeks2
 ^
.}
.{
.[h
──────┬────────────────────────────┬──────┬───────────────┬──────────┬──────────┬──────────────────┬──────┬──────────────────┬──────────────────┬──────────┬────────────────────────────┬──────────┬────────────────────────────
  NN  │         Эмитент            │ Кол  │     Номер     │  Серия   │ Процент  │   Номинальная    │Валюта│Стоимость покупки │Стоимость продажи │   Дата   │      От кого получен       │   Дата   │      Кому передан
поряд.│                            │ шт.  │               │          │ годовых  │    стоимость     │      │                  │                  │ покупки  │                            │ продажи  │
──────┴────────────────────────────┴──────┴───────────────┴──────────┴──────────┴──────────────────┴──────┴──────────────────┴──────────────────┴──────────┴────────────────────────────┴──────────┴────────────────────────────
.]h
.{ CheckEnter GruppaVeks2
 Б@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ Б &&&&&&                                       &&&&&&&&&&&&&&&&&& @@@@@@ &&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&
.}
.{ CheckEnter NameVeks2
.Begin
  if Double(Номинал_НДЕ_получение)!=0 NppPost := NppPost + 1;

  Print_Leafs := True;

  if ((AppVeks_TiDk='82')or(AppVeks_TiDk='84')or(AppVeks_TiDk='86')or(AppVeks_TiDk='88')) Curr_In := True
  else Curr_In := False;

  if (not Is_First)
  {
    if ( (Prev_nRec <> Veksl_NRec)or
         (Prev_Количество_по_акту <> DoubleToStr(Double(Количество_по_акту), Формат_кол)) )
      Prev_Another := True
    else Prev_Another := False;

    if (Curr_In)and(Prev_In)
    {
      Print_Prev := True;
      Print_Curr := False;
      Last_Printed := False;
    }
    else
    if (Curr_In)and(not Prev_In)
    {
      Print_Prev := False;
      Print_Curr := False;
      Save_Curr_Data(False);
      Last_Printed := False;
    }
    else
    if (not Curr_In)and(Prev_In)and(Prev_Another)
    {
      Print_Prev := True;
      Print_Curr := True;
      Last_Printed := True;
    }
    else
    if (not Curr_In)and(Prev_In)and(not Prev_Another)
    {
      Print_Prev := True;
      Print_Curr := False;
      Save_Curr_Data(True);
      Last_Printed := True;
    }
    else
    if (not Curr_In)and(not Prev_In)
    {
      Print_Prev := False;
      Print_Curr := True;
      Last_Printed := True;
    }
  }
  else
  {
    if (not Curr_In)
    {
      //если самая первая запись - передача, то выводим её в любом случае
      Print_Prev := False;
      Print_Curr := True;
      Last_Printed := True;
    }
    else
    {
      //иначе - сохраняем её для последующих сравнений
      Print_Prev := False;
      Print_Curr := False;
      Save_Curr_Data(False);
      Last_Printed := False;
    }
  }

  //если сортировка не установлена, то и следить не надо ни за чем,
  //ибо выдаётся предупреждение в самом начале...
  if (Сортировка_по_дате_получения)
    if (tmp_Already_Printed_Npp = Prev_Npp)
      Print_Prev := False;

End.
.{?INTERNAL;(Print_Prev)
@@@@@@ @@@@@@@@@@@@@@@@@@@@@@@@@@@@ &&&&&& @@@@@@@@@@@@@@@ @@@@@@@@@@ &&&&&&&.&& &&&&&&&&&&&&&&&&&& @@@@@@ &&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&& @@@@@@@@@@ @@@@@@@@@@@@@@@@@@@@@@@@@@@@ @@@@@@@@@@ @@@@@@@@@@@@@@@@@@@@@@@@@@@@
.}
.{?INTERNAL;(Print_Curr)
@@@@@@ @@@@@@@@@@@@@@@@@@@@@@@@@@@@ &&&&&& @@@@@@@@@@@@@@@ @@@@@@@@@@ &&&&&&&.&& &&&&&&&&&&&&&&&&&& @@@@@@ &&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&& @@@@@@@@@@ @@@@@@@@@@@@@@@@@@@@@@@@@@@@ @@@@@@@@@@ @@@@@@@@@@@@@@@@@@@@@@@@@@@@
.}
.Begin
  if (not Is_First)
    if ((Curr_In)and(Prev_In)) Save_Curr_Data(False);
  Is_First := False;
  Prev_In := Curr_In;
  Prev_nRec := Veksl_NRec;
End.
.}
.{?INTERNAL;((not Last_Printed)and(Print_Leafs))
.Begin
  tmp_Already_Printed_Npp := Prev_Npp;
End.
@@@@@@ @@@@@@@@@@@@@@@@@@@@@@@@@@@@ &&&&&& @@@@@@@@@@@@@@@ @@@@@@@@@@ &&&&&&&.&& &&&&&&&&&&&&&&&&&& @@@@@@ &&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&& @@@@@@@@@@ @@@@@@@@@@@@@@@@@@@@@@@@@@@@ @@@@@@@@@@ @@@@@@@@@@@@@@@@@@@@@@@@@@@@
.}
.{ CheckEnter ItogVeks2
 Б@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ Б &&&&&&                                       &&&&&&&&&&&&&&&&&& @@@@@@ &&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&
.}
.}

Ответственный за выпуск Ш
.EndForm

!=============================================================================
.LinkForm 'VeksMove_02' Prototype is 'VeksMove'
!=============================================================================
.NameInList 'Ведомость движения векселей (ценных бумаг)'
.Group 'Ведомости движения векселей и ценных бумаг'
.p 60
.defo landscape
.Fields
CommonFormHeader
UpCase(Субъект_отчета_родит)
Валюта_реестра
Группировка
Сортировка
!---------------- FilterVeks
Фильтр
!-----------------Хидер
Валюта_НДЕ
Валюта_НДЕ
Валюта_НДЕ
!---------------- GruppaVeks
Ветка
DoubleToStr( Double(Итого_верх_номинал_НДЕ), Формат_сумм )
DoubleToStr( Double(Итого_верх_приход_НДЕ), Формат_сумм )
DoubleToStr( Double(Итого_верх_расход_НДЕ), Формат_сумм )
!---------------- NameVeks
f_Veksl_cPlat
Номер
Серия
DoubleToStr( Double(Номинал_НДЕ),     Формат_сумм )
if (LongInt(Дата_выписки)<>0,DateToStr(Дата_выписки, 'DD/MM/YYYY'),'')
if (LongInt(Дата_акта)<>0,DateToStr(Дата_акта, 'DD/MM/YYYY'),'')
Контрагент
DoubleToStr( Double(Приход_факт_НДЕ), Формат_сумм )
DoubleToStr( Double(Расход_факт_НДЕ), Формат_сумм )
if (LongInt(Дата_закрытия)<>0,DateToStr(Дата_закрытия, 'DD/MM/YYYY'),'')
!---------------- ItogVeks
Итого
DoubleToStr( Double(Итого_номинал_НДЕ), Формат_сумм )
DoubleToStr( Double(Итого_приход_НДЕ), Формат_сумм )
DoubleToStr( Double(Итого_расход_НДЕ), Формат_сумм )
.EndFields
 Ш.[h
                                                              Лист @Np@
.]h
^

                                  ВЕДОМОСТЬ ДВИЖЕНИЯ @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

Валюта:               ^
Группировка:          ^
Сортировка:           ^
Фильтры:
.{ CheckEnter FilterVeks2
 ^
.}
.{
.[h
────────────────────┬────────────────────┬──────────┬────────────────────┬──────────┬──────────┬────────────────────┬────────────────────┬────────────────────┬──────────
     Эмитент        │       Номер        │  Серия   │    Номинальная     │Дата сост.│   Дата   │     Контрагент     │ Стоимость покупки, │ Стоимость продажи, │  Дата
                    │                    │          │   стоимость, @@@@  │ векселя  │   акта   │                    │        @@@@        │        @@@@        │ платежа
────────────────────┴────────────────────┴──────────┴────────────────────┴──────────┴──────────┴────────────────────┴────────────────────┴────────────────────┴──────────
.]h
.{ CheckEnter GruppaVeks2
 Б@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ Б &&&&&&&&&&&&&&&&&&&&                                            &&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&&
.}
.{ CheckEnter NameVeks2
@@@@@@@@@@@@@@@@@@@@ @@@@@@@@@@@@@@@@@@@@ @@@@@@@@@@ &&&&&&&&&&&&&&&&&&&& @@@@@@@@@@ @@@@@@@@@@ @@@@@@@@@@@@@@@@@@@@ &&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&& @@@@@@@@@@
.}
.{ CheckEnter ItogVeks2
 Б@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ Б &&&&&&&&&&&&&&&&&&&&                                            &&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&&
.}
.}

Ответственный за выпуск Ш
.EndForm

!=============================================================================
.LinkForm 'VeksMove_03' Prototype is 'VeksMove'
!=============================================================================
.NameInList 'Ведомость движения векселей (ценных бумаг) с детализацией платежей'
.Group 'Ведомости движения векселей и ценных бумаг'
.p 60
.defo landscape
.create view loOpl
Var
  cSpApp : comp;
  wTiDk  : word;
  (
   fDate,
   fNoDoc,
   fSum
  )
As select
! -- fDate ---------------
  if( VekslOp.DatOpl != date(0,0,0), VekslOp.DatOpl, BaseFin.dDoc),
! -- fNoDoc --------------
  BaseFin.NoDoc,
! -- fSum ----------------
  VekslOp.Sum
From
  VekslOp (VEKSLOP03),
  BaseFin
Where
  ((
    wTiDk            == VekslOp.TiDk  and
    cSpApp           == VekslOp.cGraf and
    VekslOp.cBaseFin == BaseFin.NRec
  ))
;
.Fields
CommonFormHeader
UpCase(Субъект_отчета_родит)
Валюта_реестра
Группировка
Сортировка
!---------------- FilterVeks
Фильтр
!---------------- GruppaVeks
Ветка
DoubleToStr( if(Double(Итого_верх_номинал_ВО)!=0,Double(Итого_верх_номинал_ВО),Double(Итого_верх_номинал_НДЕ)), Формат_сумм )
Валюта_верх
DoubleToStr( if(Double(Итого_верх_приход_ВО)!=0,Double(Итого_верх_приход_ВО),Double(Итого_верх_приход_НДЕ)), Формат_сумм )
DoubleToStr( if(Double(Итого_верх_расход_ВО)!=0,Double(Итого_верх_расход_ВО),Double(Итого_верх_расход_НДЕ)), Формат_сумм )
Валюта_верх
!---------------- NameVeks
f_Veksl_cPlat
Номер
Серия
DoubleToStr( if(Double(Номинал_ВО)!=0,Double(Номинал_ВО),Double(Номинал_НДЕ)),     Формат_сумм )
Валюта_строка
if (LongInt(Дата_выписки)<>0,DateToStr(Дата_выписки, 'DD/MM/YYYY'),'')
if (LongInt(Дата_акта)<>0,DateToStr(Дата_акта, 'DD/MM/YYYY'),'')
Контрагент
DoubleToStr( if(Double(Приход_факт_ВО)!=0,Double(Приход_факт_ВО),Double(Приход_факт_НДЕ)),     Формат_сумм )
DoubleToStr( if(Double(Расход_факт_ВО)!=0,Double(Расход_факт_ВО),Double(Расход_факт_НДЕ)),     Формат_сумм )
Валюта_строка
loOpl.fDate
loOpl.fNoDoc
DoubleToStr( loOpl.fSum, Формат_сумм )
Валюта_документа
!---------------- ItogVeks
Итого
DoubleToStr( if(Double(Итого_номинал_ВО)!=0,Double(Итого_номинал_ВО),Double(Итого_номинал_НДЕ)), Формат_сумм )
Валюта_низ
DoubleToStr( if(Double(Итого_приход_ВО)!=0,Double(Итого_приход_ВО),Double(Итого_приход_НДЕ)), Формат_сумм )
DoubleToStr( if(Double(Итого_расход_ВО)!=0,Double(Итого_расход_ВО),Double(Итого_расход_НДЕ)), Формат_сумм )
Валюта_низ
.EndFields
 Ш.[h
                                                              Лист @Np@
.]h
^

                                  ВЕДОМОСТЬ ДВИЖЕНИЯ @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

Валюта:               ^
Группировка:          ^
Сортировка:           ^
Фильтры:
.{ CheckEnter FilterVeks2
 ^
.}
.{
.[h
────────────────────┬────────────────────┬──────────┬────────────────────┬──────┬──────────┬──────────┬────────────────────┬────────────────────┬────────────────────┬──────┬──────────┬───────────────┬────────────────────┬──────
     Эмитент        │       Номер        │  Серия   │     Номинальная    │Валюта│Дата сост.│   Дата   │     Контрагент     │ Стоимость покупки  │ Стоимость продажи  │Валюта│  Дата    │     Номер     │   Сумма платежа    │Валюта
                    │                    │          │      стоимость     │      │ векселя  │   акта   │                    │                    │                    │      │ платежа  │   документа   │                    │
────────────────────┴────────────────────┴──────────┴────────────────────┴──────┴──────────┴──────────┴────────────────────┴────────────────────┴────────────────────┴──────┴──────────┴───────────────┴────────────────────┴──────
.]h
.{ CheckEnter GruppaVeks2
 Б@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ Б &&&&&&&&&&&&&&&&&&&& @@@@@@                                            &&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&& @@@@@@
.}
.{ CheckEnter NameVeks2
@@@@@@@@@@@@@@@@@@@@ @@@@@@@@@@@@@@@@@@@@ @@@@@@@@@@ &&&&&&&&&&&&&&&&&&&& @@@@@@ @@@@@@@@@@ @@@@@@@@@@ @@@@@@@@@@@@@@@@@@@@ &&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&& @@@@@@
.begin
  loOpl.cSpApp := comp(SpApp_NRec);
  loOpl.wTiDk  := comp(AppVeks_TiDk);
end.
.{TABLE 'loOpl.VekslOp:MAIN' BY VekslOp.DatOpl
                                                                                                                                                                             @@@@@@@@@@ @@@@@@@@@@@@@@@ &&&&&&&&&&&&&&&&&&&& @@@@@@
.}
.}
.{ CheckEnter ItogVeks2
 Б@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ Б &&&&&&&&&&&&&&&&&&&& @@@@@@                                            &&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&& @@@@@@
.}
.}

Ответственный за выпуск Ш
.EndForm

!=============================================================================
.LinkForm 'VeksMove_04' Prototype is 'VeksMove'
!=============================================================================
.NameInList 'Задолженность по векселям (ценным бумагам)'
.Group 'Ведомости движения векселей и ценных бумаг'
.p 60
.defo landscape
.Fields
CommonFormHeader
UpCase(Субъект_отчета_дат)
Валюта_реестра
Группировка
Сортировка
!---------------- FilterVeks
Фильтр
!---------------- GruppaVeks
Ветка
DoubleToStr( if(Double(Итого_верх_номинал_ВО)!=0,Double(Итого_верх_номинал_ВО),Double(Итого_верх_номинал_НДЕ)), Формат_сумм )
Валюта_верх
DoubleToStr( if(Double(Итого_верх_приход_ВО)!=0,Double(Итого_верх_приход_ВО),Double(Итого_верх_приход_НДЕ)), Формат_сумм )
DoubleToStr( if(Double(Итого_верх_приход_ВО)!=0,
               Double(Итого_верх_приход_ВО)-Double(Итого_верх_оплата_приход_ВО),
               Double(Итого_верх_приход_НДЕ)-Double(Итого_верх_оплата_приход_НДЕ)),
               Формат_сумм )
DoubleToStr( if(Double(Итого_верх_расход_ВО)!=0,Double(Итого_верх_расход_ВО),Double(Итого_верх_расход_НДЕ)), Формат_сумм )
DoubleToStr( if(Double(Итого_верх_расход_ВО)!=0,
               Double(Итого_верх_расход_ВО)-Double(Итого_верх_оплата_расход_ВО),
               Double(Итого_верх_расход_НДЕ)-Double(Итого_верх_оплата_расход_НДЕ)),
               Формат_сумм )
!---------------- NameVeks
Контрагент
if (LongInt(Дата_акта)<>0,DateToStr(Дата_акта,'DD/MM/YYYY'),'')
Номер
Серия
Бланк
DoubleToStr( if(Double(Номинал_вал)!=0,Double(Номинал_вал),Double(Номинал_НДЕ)),Формат_сумм )
Валюта_строка
DoubleToStr( if(Double(Приход_факт_вал)!=0,Double(Приход_факт_вал),Double(Приход_факт_НДЕ)),Формат_сумм )
DoubleToStr( if(Double(Приход_факт_вал)!=0,
               Double(Приход_факт_вал)-Double(Оплата_приход_вал),
               Double(Приход_факт_НДЕ)-Double(Оплата_приход_НДЕ)),
               Формат_сумм )
DoubleToStr( if(Double(Расход_факт_вал)!=0,Double(Расход_факт_вал),Double(Расход_факт_НДЕ)),Формат_сумм )
DoubleToStr( if(Double(Расход_факт_вал)!=0,
               Double(Расход_факт_вал)-Double(Оплата_расход_вал),
               Double(Расход_факт_НДЕ)-Double(Оплата_расход_НДЕ)),
               Формат_сумм )
string(Условие_наим) + ' ' + if (LongInt(Дата_закрытия)<>0,DateToStr(Дата_закрытия,'DD/MM/YYYY'),'')
!---------------- ItogVeks
Итого
DoubleToStr( if(Double(Итого_номинал_ВО)!=0,Double(Итого_номинал_ВО),Double(Итого_номинал_НДЕ)), Формат_сумм )
Валюта_низ
DoubleToStr( if(Double(Итого_приход_ВО)!=0,Double(Итого_приход_ВО),Double(Итого_приход_НДЕ)), Формат_сумм )
DoubleToStr( if(Double(Итого_приход_ВО)!=0,
               Double(Итого_приход_ВО)-Double(Итого_оплата_приход_ВО),
               Double(Итого_приход_НДЕ)-Double(Итого_оплата_приход_НДЕ)),
               Формат_сумм )
DoubleToStr( if(Double(Итого_расход_ВО)!=0,Double(Итого_расход_ВО),Double(Итого_расход_НДЕ)), Формат_сумм )
DoubleToStr( if(Double(Итого_расход_ВО)!=0,
               Double(Итого_расход_ВО)-Double(Итого_оплата_расход_ВО),
               Double(Итого_расход_НДЕ)-Double(Итого_оплата_расход_НДЕ)),
               Формат_сумм )
.EndFields
 Ш.[h
                                                                                                                                                                                                               Лист @Np@
.]h
^

                                  ЗАДОЛЖЕННОСТЬ ПО @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

Валюта:               ^
Группировка:          ^
Сортировка:           ^
Фильтры:
.{ CheckEnter FilterVeks2
 ^
.}
.{
.[h
────────────────────┬────────────┬────────────────────┬────────────────────┬──────────┬────────────────────┬──────┬────────────────────┬────────────────────┬────────────────────┬────────────────────┬─────────────────
     Контрагент     │    Дата    │       Номер        │       Серия        │  Номер   │    Номинальная     │Валюта│  Сумма получения   │Остаток непогашенной│   Сумма передачи   │Остаток непогашенной│      Срок
                    │    акта    │                    │                    │  бланка  │     стоимость      │      │                    │       суммы        │                    │       суммы        │    погашения
────────────────────┴────────────┴────────────────────┴────────────────────┴──────────┴────────────────────┴──────┴────────────────────┴────────────────────┴────────────────────┴────────────────────┴─────────────────
.]h
.{ CheckEnter GruppaVeks2
 Б@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ Б                                   &&&&&&&&&&&&&&&&&&&& @@@@@@ &&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&&
.}
.{ CheckEnter NameVeks2
@@@@@@@@@@@@@@@@@@@@  @@@@@@@@@@  @@@@@@@@@@@@@@@@@@@@ @@@@@@@@@@@@@@@@@@@@ @@@@@@@@@@ &&&&&&&&&&&&&&&&&&&& @@@@@@ &&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&& @@@@@@@@@@@@@@@@@
.}
.{ CheckEnter ItogVeks2
 Б@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ Б                                   &&&&&&&&&&&&&&&&&&&& @@@@@@ &&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&&
.}
.}

Ответственный за выпуск Ш
.EndForm

!=============================================================================
.LinkForm 'VeksMove_05' Prototype is 'VeksMove'
!=============================================================================
.NameInList 'Баланс операций с векселями (ценными бумагами)'
.Group 'Ведомости движения векселей и ценных бумаг'
.p 60
.defo landscape
.Var
  NppPost      : comp;

  Curr_In      : boolean;   //тек.строка - получение
  Prev_In      : boolean;   //предыдущая строка - получение
  Prev_Another : boolean;   //предыдущая строка - по другому векселю
  Is_First     : boolean;
  Prev_nRec    : comp;
  Print_Prev   : boolean;
  Print_Curr   : boolean;
  Last_Printed : boolean;
  Print_Leafs  : boolean;

  S1                : double;
  S2                : double;
  Gruppa_Ostatok    : string;
  Name_Prev_Ostatok : string;
  Name_Ostatok      : string;
  Itog_Ostatok      : string;

  //для сохранения строки
  Prev_Номер              : string;
  Prev_Валюта_строка      : string;
  Prev_Приход_Наличие     : double;
  Prev_Расход_факт        : double;
  Prev_Дата_акта_In       : string;
  Prev_Контрагент_In      : string;
  Prev_Дата_акта_Out      : string;
  Prev_Контрагент_Out     : string;

  tmp_Already_Printed_Npp : string; //чтобы не дублировались строки

.EndVar
.Fields
CommonFormHeader
UpCase(Субъект_отчета_творит)
Валюта_реестра
Группировка
Сортировка
!---------------- FilterVeks
Фильтр
!---------------- GruppaVeks
Ветка
if ( ifNal,
     DoubleToStr( if( Double(Итого_верх_приход_ВО)  + Double(Итого_верх_наличие_ВО) != 0,
                      Double(Итого_верх_приход_ВО)  + Double(Итого_верх_наличие_ВО),
                      Double(Итого_верх_приход_НДЕ) + Double(Итого_верх_наличие_НДЕ)), Формат_сумм),
     DoubleToStr( if( Double(Итого_верх_приход_ВО) != 0,
                      Double(Итого_верх_приход_ВО),
                      Double(Итого_верх_приход_НДЕ)),Формат_сумм))
DoubleToStr( if( Double(Итого_верх_расход_ВО) != 0,
                 Double(Итого_верх_расход_ВО),
                 Double(Итого_верх_расход_НДЕ)
               ), Формат_сумм )
Gruppa_Ostatok
Валюта_верх
!---------------- NameVeks
Prev_Контрагент_In
Prev_Номер
Prev_Дата_акта_In
DoubleToStr(Prev_Приход_Наличие, Формат_сумм)
Prev_Контрагент_Out
Prev_Дата_акта_Out
DoubleToStr(Prev_Расход_факт, Формат_сумм)
Name_Prev_Ostatok
Prev_Валюта_строка

if (((AppVeks_TiDk='82')or(AppVeks_TiDk='84')or(AppVeks_TiDk='86')or(AppVeks_TiDk='88')),Контрагент,'')
Номер
if (((AppVeks_TiDk='82')or(AppVeks_TiDk='84')or(AppVeks_TiDk='86')or(AppVeks_TiDk='88')),
    if (LongInt(Дата_акта)<>0,DateToStr(Дата_акта, 'DD/MM/YYYY'),''),'')
if( Flag1 != 1,
    DoubleToStr( if( Double(Приход_факт_вал) != 0,
                     Double(Приход_факт_вал),
                     Double(Приход_факт_НДЕ)), Формат_сумм),
    DoubleToStr( if( Double(Наличие_вал) != 0,
                     Double(Наличие_вал),
                     Double(Наличие_НДЕ)), Формат_сумм))
if (((AppVeks_TiDk='81')or(AppVeks_TiDk='83')or(AppVeks_TiDk='85')or(AppVeks_TiDk='87')),Контрагент,'')
if (((AppVeks_TiDk='81')or(AppVeks_TiDk='83')or(AppVeks_TiDk='85')or(AppVeks_TiDk='87')),
    if (LongInt(Дата_акта)<>0,DateToStr(Дата_акта, 'DD/MM/YYYY'),''),'')
DoubleToStr( if( Double(Расход_факт_вал) != 0,
                 Double(Расход_факт_вал),
                 Double(Расход_факт_НДЕ)), Формат_сумм )
Name_Ostatok
Валюта_строка

!------------ not Last_Printed
Prev_Контрагент_In
Prev_Номер
Prev_Дата_акта_In
DoubleToStr(Prev_Приход_Наличие, Формат_сумм)
Prev_Контрагент_Out
Prev_Дата_акта_Out
DoubleToStr(Prev_Расход_факт, Формат_сумм)
Name_Prev_Ostatok
Prev_Валюта_строка

!---------------- ItogVeks
Итого
if( ifNal,
    DoubleToStr( if( Double(Итого_приход_ВО)  + Double(Итого_наличие_ВО) != 0,
                     Double(Итого_приход_ВО)  + Double(Итого_наличие_ВО),
                     Double(Итого_приход_НДЕ) + Double(Итого_наличие_НДЕ)), Формат_сумм ),
    DoubleToStr( if( Double(Итого_приход_ВО) != 0,
                     Double(Итого_приход_ВО),
                     Double(Итого_приход_НДЕ)), Формат_сумм )
  )
DoubleToStr( if( Double(Итого_расход_ВО) != 0,
                 Double(Итого_расход_ВО),
                 Double(Итого_расход_НДЕ)), Формат_сумм )
Itog_Ostatok
Валюта_низ
.EndFields
 Ш.[h
                                                                                                                                                                                                                       Лист @Np@
.]h
.procedure Save_Curr_Data(Save_Both:boolean);
begin
  if (not Save_Both)
  {
    Prev_Номер              := Номер;
    Prev_Валюта_строка      := Валюта_строка;
    Prev_Приход_Наличие     := if( Flag1 <> 1, ( if( Double(Приход_факт_вал) != 0,
                                                     Double(Приход_факт_вал),
                                                     Double(Приход_факт_НДЕ))),
                                                ( if( Double(Наличие_вал) != 0,
                                                      Double(Наличие_вал),
                                                      Double(Наличие_НДЕ))));
    Prev_Дата_акта_In       := if (LongInt(Дата_акта)<>0,DateToStr(Дата_акта, 'DD/MM/YYYY'),'');
    Prev_Контрагент_In      := Контрагент;

    Prev_Расход_факт        := 0;
    Prev_Дата_акта_Out      := '';
    Prev_Контрагент_Out     := '';
  }

  if Save_Both
  {
    Prev_Расход_факт        := ( if( Double(Расход_факт_вал) != 0,
                                     Double(Расход_факт_вал),
                                     Double(Расход_факт_НДЕ)));
    Prev_Дата_акта_Out      := if (LongInt(Дата_акта)<>0,DateToStr(Дата_акта, 'DD/MM/YYYY'),'');
    Prev_Контрагент_Out     := Контрагент;
  }
end.
.begin
  NppPost:=0;
  Is_First := True;
  Last_Printed := False;
  Print_Leafs := False;
  tmp_Already_Printed_Npp := '';
  if not Сортировка_по_дате_получения
    Message(''#3'Не установлена сортировка ни по'+
         ''#13#3'дате получения, ни по порядку АПП.'+
         ''#13#3'Желательна установка этих сортировок.');
end.
^

                                  БАЛАНС ОПЕРАЦИЙ С ^

Валюта:               ^
Группировка:          ^
Сортировка:           ^
Фильтры:
.{ CheckEnter FilterVeks2
 ^
.}
.{
.[h
──────────────────────────────────────────────────┬───────────────┬──────────┬─────────────────────────┬──────────────────────────────────────────────────┬──────────┬─────────────────────────┬─────────────────────────┬──────
                 От кого получен                  │     Номер     │   Дата   │    Стоимость покупки    │                   Кому передан                   │   Дата   │    Стоимость продажи    │         Остаток         │Валюта
                                                  │   документа   │ покупки  │                         │                                                  │ продажи  │                         │                         │
──────────────────────────────────────────────────┴───────────────┴──────────┴─────────────────────────┴──────────────────────────────────────────────────┴──────────┴─────────────────────────┴─────────────────────────┴──────
.]h
.{ CheckEnter GruppaVeks2
.Begin
  S1 := if ( ifNal,( if( Double(Итого_верх_приход_ВО)  + Double(Итого_верх_наличие_ВО) != 0,
                         Double(Итого_верх_приход_ВО)  + Double(Итого_верх_наличие_ВО),
                         Double(Итого_верх_приход_НДЕ) + Double(Итого_верх_наличие_НДЕ))),
                   ( if( Double(Итого_верх_приход_ВО) != 0,
                         Double(Итого_верх_приход_ВО),
                         Double(Итого_верх_приход_НДЕ))));
  S2 :=            ( if( Double(Итого_верх_расход_ВО) != 0,
                         Double(Итого_верх_расход_ВО),
                         Double(Итого_верх_расход_НДЕ)));
  if (S1<>0)or(S2<>0)
    Gruppa_Ostatok := DoubleToStr((S1 - S2), Формат_сумм);
End.
 Б@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ Б &&&&&&&&&&&&&&&&&&&&&&&&&                                                               &&&&&&&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&&&&&&& @@@@@@
.}
.{ CheckEnter NameVeks2
.Begin
  if Double(Номинал_НДЕ_получение)!=0 NppPost := NppPost + 1;

  Print_Leafs := True;

  if ((AppVeks_TiDk='82')or(AppVeks_TiDk='84')or(AppVeks_TiDk='86')or(AppVeks_TiDk='88')) Curr_In := True
  else Curr_In := False;

  if (not Is_First)
  {
    if (Prev_nRec <> Veksl_NRec)
      Prev_Another := True
    else Prev_Another := False;

    if (Curr_In)and(Prev_In)
    {
      Print_Prev := True;
      Print_Curr := False;
      Last_Printed := False;
    }
    else
    if (Curr_In)and(not Prev_In)
    {
      Print_Prev := False;
      Print_Curr := False;
      Save_Curr_Data(False);
      Last_Printed := False;
    }
    else
    if (not Curr_In)and(Prev_In)and(Prev_Another)
    {
      Print_Prev := True;
      Print_Curr := True;
      Last_Printed := True;
    }
    else
    if (not Curr_In)and(Prev_In)and(not Prev_Another)
    {
      Print_Prev := True;
      Print_Curr := False;
      Save_Curr_Data(True);
      Last_Printed := True;
    }
    else
    if (not Curr_In)and(not Prev_In)
    {
      Print_Prev := False;
      Print_Curr := True;
      Last_Printed := True;
    }
  }
  else
  {
    if (not Curr_In)
    {
      //если самая первая запись - передача, то выводим её в любом случае
      Print_Prev := False;
      Print_Curr := True;
      Last_Printed := True;
    }
    else
    {
      //иначе - сохраняем её для последующих сравнений
      Print_Prev := False;
      Print_Curr := False;
      Save_Curr_Data(False);
      Last_Printed := False;
    }
  }

  //если сортировка не установлена, то и следить не надо ни за чем,
  //ибо выдаётся предупреждение в самом начале...
  if (Сортировка_по_дате_получения)
    if (tmp_Already_Printed_Npp = Prev_Номер)
      Print_Prev := False;

End.
.{?INTERNAL;(Print_Prev)
.Begin
  S1 := Prev_Приход_Наличие;
  S2 := Prev_Расход_факт;
  Name_Prev_Ostatok := DoubleToStr((S1 - S2), Формат_сумм);
End.
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ @@@@@@@@@@@@@@@ @@@@@@@@@@ &&&&&&&&&&&&&&&&&&&&&&&&& @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ @@@@@@@@@@ &&&&&&&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&&&&&&& @@@@@@
.}
.{?INTERNAL;(Print_Curr)
.Begin
  S1 := if( Flag1 <> 1,( if( Double(Приход_факт_вал) != 0,
                             Double(Приход_факт_вал),
                             Double(Приход_факт_НДЕ))),
                       ( if( Double(Наличие_вал) != 0,
                             Double(Наличие_вал),
                             Double(Наличие_НДЕ))));
  S2 :=                ( if( Double(Расход_факт_вал) != 0,
                             Double(Расход_факт_вал),
                             Double(Расход_факт_НДЕ)));
  Name_Ostatok := DoubleToStr((S1-S2), Формат_сумм);
End.
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ @@@@@@@@@@@@@@@ @@@@@@@@@@ &&&&&&&&&&&&&&&&&&&&&&&&& @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ @@@@@@@@@@ &&&&&&&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&&&&&&& @@@@@@
.}
.Begin
  if (not Is_First)
    if ((Curr_In)and(Prev_In)) Save_Curr_Data(False);
  Is_First := False;
  Prev_In := Curr_In;
  Prev_nRec := Veksl_NRec;
End.
.}
.{?INTERNAL;((not Last_Printed)and(Print_Leafs))
.Begin
  S1 := Prev_Приход_Наличие;
  S2 := Prev_Расход_факт;
  Name_Prev_Ostatok := DoubleToStr((S1 - S2), Формат_сумм);
  tmp_Already_Printed_Npp := Prev_Номер;
End.
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ @@@@@@@@@@@@@@@ @@@@@@@@@@ &&&&&&&&&&&&&&&&&&&&&&&&& @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ @@@@@@@@@@ &&&&&&&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&&&&&&& @@@@@@
.}
.{ CheckEnter ItogVeks2
.Begin
  S1 := if( ifNal,( if( Double(Итого_приход_ВО)  + Double(Итого_наличие_ВО) != 0,
                        Double(Итого_приход_ВО)  + Double(Итого_наличие_ВО),
                        Double(Итого_приход_НДЕ) + Double(Итого_наличие_НДЕ))),
                  ( if( Double(Итого_приход_ВО) != 0,
                        Double(Итого_приход_ВО),
                        Double(Итого_приход_НДЕ))));
  S2 :=           ( if( Double(Итого_расход_ВО) != 0,
                        Double(Итого_расход_ВО),
                        Double(Итого_расход_НДЕ)));
  if (S1<>0)or(S2<>0)
    Itog_Ostatok := DoubleToStr((S1 - S2), Формат_сумм);
End.
 Б@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ Б &&&&&&&&&&&&&&&&&&&&&&&&&                                                               &&&&&&&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&&&&&&& @@@@@@
.}
.}

Ответственный за выпуск Ш
.EndForm

!=============================================================================
.LinkForm 'VeksMove_06' Prototype is 'VeksMove'
!=============================================================================
.NameInList 'Реализация векселей (ценных бумаг) для формы 100.02'
.Group 'Реализация векселей и ценных бумаг <<Казахстан>>'
.p 80
.defo portrait
.create view loSpApp
From
  SpApp
Where
((
  comp(SpApp_NRec) == SpApp.NRec
))
;
.var
  Npp                               : word;
  IsGetFirst                        : boolean;
  NameVeks_Приход_Наличие           : double;
  NameVeks_Расход_факт              : double;
  NameVeks_Доходы_Убытки            : double;
  Итого_Стоимость_Приобретения      : double;
  Итого_Стоимость_Реализации        : double;
  Итого_Доходы_Убытки               : double;
  Итого_Доходы                      : double;
  Итого_Убытки                      : double;
.endvar
.Fields
CommonFormHeader
UpCase(Субъект_отчета_родит)
Валюта_реестра
Группировка
Сортировка
!---------------- FilterVeks
Фильтр
!---------------- NameVeks
Npp
if (Серия<>'','Серия ' + Серия + ' ', '') +
if (Номер<>'','Номер ' + Номер + ' ', '') +
if (Дата_выписки<> date(0,0,0),'Дата ' + DateToStr(Дата_выписки,'DD/MM/YYYY') + ' ', '')
DoubleToStr(NameVeks_Приход_Наличие , Формат_сумм)
DoubleToStr(NameVeks_Расход_факт    , Формат_сумм)
DoubleToStr(NameVeks_Доходы_Убытки  , Формат_сумм)
//Итого
DoubleToStr( Итого_Стоимость_Приобретения, Формат_сумм )
DoubleToStr( Итого_Стоимость_Реализации  , Формат_сумм )
DoubleToStr( Итого_Доходы_Убытки         , Формат_сумм)
!-----------------Итого_Доходы
DoubleToStr(Итого_Доходы           , Формат_сумм)
!-----------------Итого_Убытки
DoubleToStr(Итого_Убытки           , Формат_сумм)
.EndFields
^

  Б                     И   РЕАЛИЗАЦИЯ @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ Й
                            Р(для формы 100.02) Р

 ИВалюта:               ^
Группировка:          ^
Сортировка:           ^
Фильтры:
.{ CheckEnter FilterVeks2
 ^
.}
.begin
  Npp := 0;
  Итого_Стоимость_Приобретения      := 0;
  Итого_Стоимость_Реализации        := 0;
  Итого_Доходы_Убытки               := 0;
  Итого_Доходы                      := 0;
  Итого_Убытки                      := 0;
end.
.{
.[h
 И──────┬─────────────────────────────────────────┬──────────────┬──────────────┬──────────────
Номер │       Наименование ценных бумаг         │   Стоимость  │  Стоимость   │   Доходы,
строки│                                         │ приобретения │  реализации  │   убытки
──────┴─────────────────────────────────────────┴──────────────┴──────────────┴────────────── И
.]h
.begin
  NameVeks_Приход_Наличие           := 0;
  NameVeks_Расход_факт              := 0;
  NameVeks_Доходы_Убытки            := 0;
end.
.{ CheckEnter GruppaVeks2
.}
.{ CheckEnter NameVeks2
.begin
  IsGetFirst := False;
  if (((AppVeks_TiDk='81')or(AppVeks_TiDk='83')or(AppVeks_TiDk='85')or(AppVeks_TiDk='87'))
      and  (loSpApp.GetFirst SpApp = tsOk)) IsGetFirst := True;
  if IsGetFirst
  {
    Npp := Npp + 1;
    NameVeks_Приход_Наличие := loSpApp.SpApp.SumOp * loSpApp.SpApp.kol;
    NameVeks_Расход_факт    := loSpApp.SpApp.SumPl * loSpApp.SpApp.kol;
    NameVeks_Доходы_Убытки  := NameVeks_Расход_факт - NameVeks_Приход_Наличие;
    if ( NameVeks_Доходы_Убытки > 0 )
      Итого_Доходы := Итого_Доходы + NameVeks_Доходы_Убытки;
    else
      Итого_Убытки := Итого_Убытки - NameVeks_Доходы_Убытки;
    Итого_Стоимость_Приобретения := Итого_Стоимость_Приобретения + NameVeks_Приход_Наличие;
    Итого_Стоимость_Реализации   := Итого_Стоимость_Реализации + NameVeks_Расход_факт;
  }
end.
.{?INTERNAL;(IsGetFirst)
 И @~@@@ @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &&&&&&&&&&&&&& &&&&&&&&&&&&&& &&&&&&&&&&&&&& И
.}
.}
.{ CheckEnter ItogVeks2
.}
.}
.begin
  Итого_Доходы_Убытки := Итого_Доходы - Итого_Убытки ;
end.
 И─────────────────────────────────────────────────────────────────────────────────────────────
 Итого                                           &&&&&&&&&&&&&& &&&&&&&&&&&&&& &&&&&&&&&&&&&& И
 И Итого доходов                                                                 &&&&&&&&&&&&&& И
 И Итого убытков                                                                 &&&&&&&&&&&&&& И

 И.EndForm
 И
 И!=============================================================================
.LinkForm 'VeksMove_07' Prototype is 'VeksMove'
!=============================================================================
.NameInList 'Реализация векселей (ценных бумаг) для формы 100.02 с учетом дисконта'
.Group 'Реализация векселей и ценных бумаг <<Казахстан>>'
.p 80
.defo landscape
.create view loSpApp
From
  SpApp
Where
((
  comp(SpApp_NRec) == SpApp.NRec
))
;
.var
  Npp                               : word;
  IsGetFirst                        : boolean;
  Срок_Обращения                    : word;
  Дата_Приобретения                 : date;
  Дата_Реализации                   : date;
  NameVeks_Стоимость_Приобретения   : double;
  NameVeks_Сумма_Дисконта           : double;
  NameVeks_Стоимость_Реализации     : double;
  NameVeks_Сумма_Аморт_Дисконта     : double;
  NameVeks_Доходы_Убытки            : double;
  Итого_Доходы_Убытки               : double;
  Итого_Доходы                      : double;
  Итого_Убытки                      : double;
.endvar
.Fields
CommonFormHeader
UpCase(Субъект_отчета_родит)
Валюта_реестра
Группировка
Сортировка
!---------------- FilterVeks
Фильтр
!---------------- NameVeks
Npp
if (Серия<>'','Серия ' + Серия + ' ', '') +
if (Номер<>'','Номер ' + Номер + ' ', '') +
if (Дата_выписки<>date(0,0,0),'Дата ' + DateToStr(Дата_выписки,'DD/MM/YYYY') + ' ', '')
DoubleToStr( Double(Количество_по_акту), Формат_кол )
Срок_Обращения
DoubleToStr( Double(Номинал_НДЕ), Формат_сумм )
DoubleToStr(NameVeks_Стоимость_Приобретения , Формат_сумм)
if (Дата_Приобретения<>date(0,0,0),DateToStr(Дата_Приобретения,'DD/MM/YYYY'), '')
DoubleToStr(NameVeks_Сумма_Дисконта         , Формат_сумм)
DoubleToStr(NameVeks_Стоимость_Реализации   , Формат_сумм)
if (Дата_Реализации<>date(0,0,0),DateToStr(Дата_Реализации,'DD/MM/YYYY'), '')
DoubleToStr(NameVeks_Сумма_Аморт_Дисконта   , Формат_сумм)
DoubleToStr(NameVeks_Доходы_Убытки          , Формат_сумм)
//Итого
DoubleToStr(Итого_Доходы_Убытки    , Формат_сумм)
!-----------------Итого_Доходы
DoubleToStr(Итого_Доходы           , Формат_сумм)
!-----------------Итого_Убытки
DoubleToStr(Итого_Убытки           , Формат_сумм)
.EndFields
^
.begin
  Итого_Доходы_Убытки               := 0;
  Итого_Доходы                      := 0;
  Итого_Убытки                      := 0;
end.

                                    РЕАЛИЗАЦИЯ @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
                                     (для формы 100.02)
 И
 ИВалюта:               ^
Группировка:          ^
Сортировка:           ^
Фильтры:
.{ CheckEnter FilterVeks2
 ^
.}
.{
.[h
 Р──────┬────────────────────────────────────────────┬──────┬───────────┬─────────────┬─────────────┬──────────┬──────────────┬─────────────┬──────────┬──────────────┬──────────────
Номер │     Наименование долговых ценных бумаг     │Коли- │Срок обра- │ Номинальная │  Стоимость  │ Дата при-│Сумма дисконта│  Стоимость  │   Дата   │Сумма аморти- │   Доходы,
строки│                                            │чество│щения, дней│  стоимость  │ приобретения│ обретения│   (премии)   │  реализации │реализации│зации дисконта│   убытки
──────┴────────────────────────────────────────────┴──────┴───────────┴─────────────┴─────────────┴──────────┴──────────────┴─────────────┴──────────┴──────────────┴────────────── Р
.]h
.begin
  Npp            := 0;
  Дата_Реализации   := Date(0,0,0);
  Дата_Приобретения := Date(0,0,0);
  NameVeks_Стоимость_Приобретения   := 0;
  NameVeks_Сумма_Дисконта           := 0;
  NameVeks_Стоимость_Реализации     := 0;
  NameVeks_Сумма_Аморт_Дисконта     := 0;
  NameVeks_Доходы_Убытки            := 0;
end.
.{ CheckEnter GruppaVeks2
.}
.{ CheckEnter NameVeks2
.begin
  Срок_Обращения := 0;
  if ((AppVeks_TiDk='82')or(AppVeks_TiDk='84')or(AppVeks_TiDk='86')or(AppVeks_TiDk='88'))
    IsGetFirst := False;
  else
    IsGetFirst := True;
  if not IsGetFirst
  {
    Дата_Приобретения := Дата_акта;
    if (loSpApp.GetFirst SpApp = tsOk)
      NameVeks_Стоимость_Приобретения := loSpApp.SpApp.SumPl * loSpApp.SpApp.kol;
    NameVeks_Сумма_Дисконта := Double(Номинал_НДЕ) - NameVeks_Стоимость_Приобретения;
  }
  else
  {
    Npp := Npp + 1;
    Дата_Реализации := Дата_акта;
    if (loSpApp.GetFirst SpApp = tsOk)
      NameVeks_Стоимость_Реализации := loSpApp.SpApp.SumPl * loSpApp.SpApp.kol;
    if ((Дата_закрытия <> date(0,0,0)) and (Дата_выписки) <> date(0,0,0))
      Срок_Обращения := To_Days(Дата_закрытия) - To_Days(Дата_выписки);
    if ((Дата_Приобретения <> date(0,0,0)) and (Дата_Реализации) <> date(0,0,0)
          and (Срок_Обращения <> 0))
    NameVeks_Сумма_Аморт_Дисконта := (NameVeks_Сумма_Дисконта/Срок_Обращения) *
        (To_Days(Дата_Реализации) - To_Days(Дата_Приобретения));
    NameVeks_Доходы_Убытки  := (NameVeks_Стоимость_Реализации -
      (NameVeks_Стоимость_Приобретения + NameVeks_Сумма_Аморт_Дисконта)) * Double(Количество);
    if ( NameVeks_Доходы_Убытки > 0 )
      Итого_Доходы := Итого_Доходы + NameVeks_Доходы_Убытки;
    else
      Итого_Убытки := Итого_Убытки - NameVeks_Доходы_Убытки;
  }
end.
.{?INTERNAL;(IsGetFirst)
 Р @~@@@ @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ &&&&&& &&&&&&&&&&& &&&&&&&&&&&&& &&&&&&&&&&&&& @@@@@@@@@@ &&&&&&&&&&&&&& &&&&&&&&&&&&& @@@@@@@@@@ &&&&&&&&&&&&&& &&&&&&&&&&&&&& Р
.}
.}
.{ CheckEnter ItogVeks2
.}
.}
.begin
  Итого_Доходы_Убытки := Итого_Доходы - Итого_Убытки ;
end.
 Р───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
 Итого                                                                                                                                                               &&&&&&&&&&&&&&
 Итого доходов                                                                                                                                                       &&&&&&&&&&&&&&
 Итого убытков                                                                                                                                                       &&&&&&&&&&&&&& Р


.EndForm

!=============================================================================
.LinkForm 'VeksMove_08' Prototype is 'VeksMove'
!=============================================================================
.NameInList 'Реестр движения векселей (налоговый)'
.Group 'Ведомости движения векселей'
.p 60
.defo landscape
.Fields
CommonFormHeader
Валюта_реестра
Группировка
Сортировка
!---------------- FilterVeks
Фильтр
!-----------------Хидер
Валюта_НДЕ
Валюта_НДЕ
Валюта_НДЕ
!---------------- GruppaVeks
Ветка
DoubleToStr( Double(Итого_верх_номинал_НДЕ), Формат_сумм )
DoubleToStr( Double(Итого_верх_приход_НДЕ), Формат_сумм )
DoubleToStr( Double(Итого_верх_расход_НДЕ), Формат_сумм )
!---------------- NameVeks
f_Veksl_cPlat
Номер
Серия
DoubleToStr( Double(Номинал_НДЕ),     Формат_сумм )
if (LongInt(Дата_выписки)<>0,DateToStr(Дата_выписки, 'DD/MM/YYYY'),'')
if (LongInt(Дата_акта)<>0,DateToStr(Дата_акта, 'DD/MM/YYYY'),'')
Контрагент
DoubleToStr( Double(Приход_факт_НДЕ), Формат_сумм )
DoubleToStr( Double(Расход_факт_НДЕ), Формат_сумм )
if (LongInt(Дата_закрытия)<>0,DateToStr(Дата_закрытия, 'DD/MM/YYYY'),'')
if (Наличие_налоговой_справки, 'Да', '')
!---------------- ItogVeks
Итого
DoubleToStr( Double(Итого_номинал_НДЕ), Формат_сумм )
DoubleToStr( Double(Итого_приход_НДЕ), Формат_сумм )
DoubleToStr( Double(Итого_расход_НДЕ), Формат_сумм )
.EndFields
 Ш.[h
                                                              Лист @Np@
.]h
^

                                  РЕЕСТР ДВИЖЕНИЯ ВЕКСЕЛЕЙ

Валюта:               ^
Группировка:          ^
Сортировка:           ^
Фильтры:
.{ CheckEnter FilterVeks2
 ^
.}
.{
.[h
────────────────────┬────────────────────┬──────────┬────────────────────┬──────────┬──────────┬────────────────────┬────────────────────┬────────────────────┬──────────┬─────────────────
     Эмитент        │       Номер        │  Серия   │    Номинальная     │Дата сост.│   Дата   │     Контрагент     │ Стоимость покупки, │ Стоимость продажи, │  Дата    │Наличие налоговой
                    │                    │          │   стоимость, @@@@  │ векселя  │   акта   │                    │        @@@@        │        @@@@        │ платежа  │     справки
────────────────────┴────────────────────┴──────────┴────────────────────┴──────────┴──────────┴────────────────────┴────────────────────┴────────────────────┴──────────┴─────────────────
.]h
.{ CheckEnter GruppaVeks2
 Б@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ Б &&&&&&&&&&&&&&&&&&&&                                            &&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&&
.}
.{ CheckEnter NameVeks2
@@@@@@@@@@@@@@@@@@@@ @@@@@@@@@@@@@@@@@@@@ @@@@@@@@@@ &&&&&&&&&&&&&&&&&&&& @@@@@@@@@@ @@@@@@@@@@ @@@@@@@@@@@@@@@@@@@@ &&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&& @@@@@@@@@@        @@@
.}
.{ CheckEnter ItogVeks2
 Б@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ Б &&&&&&&&&&&&&&&&&&&&                                            &&&&&&&&&&&&&&&&&&&& &&&&&&&&&&&&&&&&&&&&
.}
.}

Ответственный за выпуск Ш
.EndForm

