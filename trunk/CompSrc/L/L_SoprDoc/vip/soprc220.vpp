//********************************************************************************
//                                                        (c) корпорация Галактика
// Галактика 7.12 - _
// _
//********************************************************************************

!╔═══════════════════════════════════════════════════════════════════════════╗
!║ Назначение    : поле KatSopr.dPrice в сопроводительных документах         ║
!╚═══════════════════════════════════════════════════════════════════════════╝

  var VCourse: double;   VCourse := GetCursPrice;
  var wPrice  : word;     wPrice := if (KatSopr.cVal = 0, 0, 1);//пересчет цен в валюте/НДЕ

  if (RunDialog(PriceChangeDialog, wPrice) = cmCancel)
    {
      RereadRecord(#KatSopr);//восстановить старое значение
      Stop;//чтобы остановить вызов календаря
      Exit;
    }

  PushPos(#SpSopr);
  ResetBounds(#SpSopr);  //чтобы захватить SpSopUsl соп.услуги
  _LOOP SpSopr where ((KatSopr.nRec == SpSopr.cSopr))
    case wPrice of
     0: //пересчет цен в валюте
      {
        SpSopr.VPrice := SpSopr.Price/VCourse;
        SpSopr.rVPrice := SpSopr.rPrice/VCourse;
        if update current SpSopr<>tsOK{};
      }
     1: //пересчет цен в НДЕ
      {
        SpSopr.Price := SpSopr.VPrice*VCourse;
        SpSopr.rPrice := SpSopr.rVPrice*VCourse;
        if update current SpSopr<>tsOK{};
      }
    end;
  SetBounds(#SpSopr);
  PopPos(#SpSopr);

  //обновление данных
  Update_Record_KatSopr;

  CheckSumma(true);

  #ifdef _SOPRDOC_VIP
  CursV := GetCursPrice;
  #end
  #ifdef _SOPRDOCB_VIP
  CursV := GetCursPrice;
  #end
  Stop; //чтобы остановить вызов календаря
