!╔═══════════════════════════════════════════════════════════════════════════╗
!║ Назначение    : HandleEvent из soprdocb.vip                               ║
!╚═══════════════════════════════════════════════════════════════════════════╝

#include SOPRC13.VPP

cmPick :
  Case CurField of
    #NalOrgSpSopUsl.Name :
      {
        If KatSopr.cStepDoc <> 0
          if (Message(''#3'Вы согласны внести несоответствие'#13#3+
                      'между налогами накладной и ДО ?',YesNo) <> cmYes)
            {
              rereadrecord(#SpDocNalSopUsl);
              Exit;
            }
       if (KatSopr.VhodNal = 1)
         Message(''#3'Изменение организации невозможно по документу, '+
                     'у которого налоги входят в цену позиций.',CancelButton);
       else 
         RunInterface(GetKatOr, SpDocNalSopUsl.cOrg,comp(0),false,comp(0),comp(0))

       good_SpDocNalSopUsl;
     }
  end; // case CurField

cmCheckField :
  {
    If KatSopr.cStepDoc <> 0
      if (Message(''#3'Вы согласны внести несоответствие'#13#3+
        'между налогами накладной и ДО ?',YesNo) <> cmYes)
        {
          rereadrecord(#SpDocNalSopUsl);
          Exit;
        }

    Case CurField of
      #SpDocNalSopUsl.SumVal, 
      #SpDocNalSopUsl.Summa:
        {
          if (curfield=#SpDocNalSopUsl.Summa)
            SpDocNalSopUsl.SumVal := SpDocNalSopUsl.Summa /GetCursPrice ;
          else
            SpDocNalSopUsl.Summa := SpDocNalSopUsl.SumVal * GetCursPrice;

          SpDocNalSopUsl.SumNal := SpDocNalSopUsl.Summa;

          SpSopUsl.ManualTax := 1;
          update current SpSopUsl;
          good_SpDocNalSopUsl;
        }
      #SpDocNalSopUsl.Nalog:
        if (message(''#3'Пересчитать сумму налога?', Information + YesNo) = cmYes)
          {
            if oldnalog <> 0
              {
                SpDocNalSopUsl.Summa  := SpDocNalSopUsl.Summa  / oldNalog *  SpDocNalSopUsl.Nalog;
                SpDocNalSopUsl.SumVal := SpDocNalSopUsl.SumVal / oldNalog *  SpDocNalSopUsl.Nalog;
                SpDocNalSopUsl.SumNal := SpDocNalSopUsl.SumNal / oldNalog *  SpDocNalSopUsl.Nalog;
              }
            oldNalog := SpDocNalSopUsl.Nalog;

            SpSopUsl.ManualTax := 1;
            update current SpSopUsl;
            good_SpDocNalSopUsl;
          }
     end;
  }

cmPositionChanged :
  oldNalog := SpDocNalSopUsl.Nalog;
