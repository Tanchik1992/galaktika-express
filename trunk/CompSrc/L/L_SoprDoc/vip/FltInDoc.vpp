//╔═══════════════════════════════════════════╗
//║ для "горячей клавиши Alt+F, если не нужно,╚═╗
//║       можно закомментировать                ║
//║ во всех меню прописан cmCallFilter        ╔═╝
//╚═══════════════════════════════════════════╝

#ifdef _SOPRDOC_VIP
cmFilterSave:
  ProcessCommand(cmCallFilter);
#end

//cmNal:
//  ProcessCommand(cmCallFilter);

//Установка\снятие фильтра в сопроводительных документах
//Работает фильтр и по нулевым полям
cmCallFilter:
{
  var sAddTitle: string;   sAddTitle := '';           //прибавить к заголовку
  var sTitle   : string;   sTitle    := '';
  var tMyRec   : comp;     tMyRec    := KatSopr.NRec;
  var tMyDocFlt: boolean;  tMyDocFlt := true;         //для отмены фильтров
  var isReread : boolean;  //запись перечитана
  var isSortDN : boolean;  //сортировка по дате создания и номеру
  var bRInit   : boolean;  bRInit := FALSE;
  var bRI      : boolean;  bRI    := FALSE;
  var WD_1 : word;

  if Pos('ФИЛЬТР:', CurrentInterfaceTitle) = 0
    strTitle  := CurrentInterfaceTitle;

  if NOT ReadMyDsk(bRInit, '_InitKatSopr_' + sTypeDoc, TRUE)
    bRInit := FALSE;

  SaveMyDsk(FALSE, '_InitKatSopr_' + sTypeDoc);

  if (bRInit)
    {
      ReadDSK2(pRecFltDoc);
      bRI := TRUE;
    }
  else
    {
      SaveMyDSK(sTypeDoc, 'Filter_Tip_Doc');

      if RunInterface('FltInDoc',KatSopr.VidSopr,pRecFltDoc) = cmDefault
        bRI := TRUE;
    }

  SaveMyDsk(FALSE, '_InitKatSopr_' + sTypeDoc);

  WD_1 := if (pRecFltDoc.WD  <> 0, pRecFltDoc.WD - 1, pRecFltDoc.WD);

  WhatDate := WD_1;

  if (bRI)
  {
    tMyDocFlt := pRecFltDoc.Filter <> 0;
    isSortDN  := (WD_1 = 0) and ((pRecFltDoc.wSort and 1) = 1);

    if (pRecFltDoc.WD <> 0)
      {
        BegDate  := pRecFltDoc.bDate;
        EndDate  := pRecFltDoc.eDate;
        isFilter := TRUE;
        SetDocBound;
      }
    else
      {
        isFilter := FALSE;
        sTitle   := '';
        SetDocBound;
      }

    if tMyDocFlt
    {
      //фильтр по ДО
      if (BoundActive(tbFiltrByDODN))  SubBounds(tbFiltrByDODN);
      if (BoundActive(tbFiltrByDO))    SubBounds(tbFiltrByDO);

      if (pRecFltDoc.Filter and 1) = 1
      {
        if (isSortDN)
          AddBounds(tbFiltrByDODN);
        else
          AddBounds(tbFiltrByDO);
      }

      //фильтр по договору
      if (BoundActive(tbFiltrByDogDN))  SubBounds(tbFiltrByDogDN);
      if (BoundActive(tbFiltrByDog))    SubBounds(tbFiltrByDog);

      if (pRecFltDoc.Filter and 2) = 2
      {
        if (isSortDN)
          AddBounds(tbFiltrByDogDN);
        else
          AddBounds(tbFiltrByDog);
      }

      //фильтр по соглашению
      if (BoundActive(tbFiltrByAppDogDN))  SubBounds(tbFiltrByAppDogDN);
      if (BoundActive(tbFiltrByAppDog))    SubBounds(tbFiltrByAppDog);

      if (pRecFltDoc.Filter and 4) = 4
      {
        if (isSortDN)
          AddBounds(tbFiltrByAppDogDN);
        else
          AddBounds(tbFiltrByAppDog);
      }

      //фильтр по ПКП
      if (BoundActive(tbFiltrByCalPlanDN))  SubBounds(tbFiltrByCalPlanDN);
      if (BoundActive(tbFiltrByCalPlan))    SubBounds(tbFiltrByCalPlan);

      if (pRecFltDoc.Filter and 8) = 8
      {
        if (isSortDN)
          AddBounds(tbFiltrByCalPlanDN);
        else
          AddBounds(tbFiltrByCalPlan);
      }

      //фильтр по контрагенту
      if (BoundActive(tbFiltrByOrgBaseDN))  SubBounds(tbFiltrByOrgBaseDN);
      if (BoundActive(tbFiltrByOrgBase))    SubBounds(tbFiltrByOrgBase);

      if (pRecFltDoc.Filter and 16) = 16
      {
        if (isSortDN)
          AddBounds(tbFiltrByOrgBaseDN);
        else
          AddBounds(tbFiltrByOrgBase);
      }

      //фильтр по дескриптору
      if (BoundActive(tbFiltrByDescrDN))  SubBounds(tbFiltrByDescrDN);
      if (BoundActive(tbFiltrByDescr))    SubBounds(tbFiltrByDescr);

      if (pRecFltDoc.Filter and 32) = 32
      {
        if (isSortDN)
          AddBounds(tbFiltrByDescrDN);
        else
          AddBounds(tbFiltrByDescr);
      }

      //фильтр по группе дескрипторов
      if (BoundActive(tbFiltrByDesgrDN))  SubBounds(tbFiltrByDesgrDN);
      if (BoundActive(tbFiltrByDesgr))    SubBounds(tbFiltrByDesgr);

      if (pRecFltDoc.Filter and 64) = 64
      {
        if (isSortDN)
          AddBounds(tbFiltrByDesgrDN);
        else
          AddBounds(tbFiltrByDesgr);
      }

      //фильтр по назначению
      if (BoundActive(tbFiltrByNazna))    SubBounds(tbFiltrByNazna);

      if (pRecFltDoc.Filter and 128) = 128
          AddBounds(tbFiltrByNazna);

          //фильтр по контрагенту
          if (BoundActive(tbFiltrGruzToDN))  SubBounds(tbFiltrGruzToDN);
          if (BoundActive(tbFiltrGruzTo))    SubBounds(tbFiltrGruzToDN);

          if (pRecFltDoc.Filter and 256) = 256
            {
              if (isSortDN)
                AddBounds(tbFiltrGruzToDN);
              else
                AddBounds(tbFiltrGruzTo);
            }

          //фильтр по форме расчета
          if (BoundActive(tbFiltrPaymentDN))  SubBounds(tbFiltrPaymentDN);
          if (BoundActive(tbFiltrPayment))    SubBounds(tbFiltrPaymentDN);

          if (pRecFltDoc.Filter and 512) = 512
            {
              if (isSortDN)
                AddBounds(tbFiltrPaymentDN);
              else
                AddBounds(tbFiltrPayment);
            }

          //фильтр по контрагенту
          if (BoundActive(tbFiltrByStatusDN))  SubBounds(tbFiltrByStatusDN);
          if (BoundActive(tbFiltrByStatus))    SubBounds(tbFiltrByStatus);

          if (pRecFltDoc.Filter and 1024) = 1024
            {
              if (isSortDN)
                AddBounds(tbFiltrByStatusDN);
              else
                AddBounds(tbFiltrByStatus);
            }

          //фильтр по центру ответственности
          if (BoundActive(tbFiltrByFPCODN))  SubBounds(tbFiltrByFPCODN);
          if (BoundActive(tbFiltrByFPCO))    SubBounds(tbFiltrByFPCO);

          if (pRecFltDoc.Filter and 2048) = 2048
            {
              if (isSortDN)
                AddBounds(tbFiltrByFPCODN);
              else
                AddBounds(tbFiltrByFPCO);
            }

          //фильтр по центру ответственности
          if (BoundActive(tbFiltrByKatStroyDN))  SubBounds(tbFiltrByKatStroyDN);
          if (BoundActive(tbFiltrByKatStroy))    SubBounds(tbFiltrByKatStroy);

          if (TypeSopr = 110)
          if (pRecFltDoc.Filter and 4096) = 4096
            {
              if (isSortDN)
                AddBounds(tbFiltrByKatStroyDN);
              else
                AddBounds(tbFiltrByKatStroy);
            }

      StartNewVisual (vtRotateVisual, vfTimer+vfThread, ''#3'Идет фильтрация...', 1);

      SaveMyDSK(TRUE  , 'Filter_Nakl_bFilterNakl_' + sTypeDoc);

      if (GetLast KatSopr <> tsOk)
      {
        tMyDocFlt := FALSE;
        isFilter  := FALSE;
        sTitle    := '';
      }

      //для заголовка  *****************************************************************
      if (tMyDocFlt)
      {
        ReReadRecord(#KatSopr)

        if (BoundActive(tbFiltrByDODN) or BoundActive(tbFiltrByDO))
          sAddTitle := sAddTitle + 'ДО № '  + if(KatSopr.cStepDoc = 0, '"--"  ', '"' + BaseDoc.NoDoc + '"  ');

        if (BoundActive(tbFiltrByDogDN) or BoundActive(tbFiltrByDog))
          sAddTitle := sAddTitle + 'ДОГ.№ ' + if(KatSopr.cDogovor = 0, '"--"  ', '"' + Dogovor.NoDoc + '"');

        if (BoundActive (tbFiltrByAppDogDN) or BoundActive (tbFiltrByAppDog))
          sAddTitle := sAddTitle + 'СОГЛ.№ '+ if(KatSopr.cAppDogovor = 0, '"--"  ', '"' + AppDogovor.NoDoc + '"  ');

        if (BoundActive (tbFiltrByCalPlanDN) or BoundActive (tbFiltrByCalPlan))
          sAddTitle := sAddTitle + 'ПКП № ' + if(KatSopr.cCalPlan = 0, '"--"  ', '"' + CalPlan.NoDoc + '"  ');

        if (BoundActive (tbFiltrByOrgBaseDN) or BoundActive (tbFiltrByOrgBase))
          sAddTitle := sAddTitle + 'КОНТРАГЕНТ ' + if(KatSopr.cOrgBase = 0, '"--"  ', '"' + KatOrg.Name + '"  ');

        if (BoundActive (tbFiltrByDescrDN) or BoundActive (tbFiltrByDescr))
          sAddTitle := sAddTitle + 'ДЕСКР. ' + '"' + KatSopr.Descr + '"  ';

        if (BoundActive (tbFiltrByDesgrDN) or BoundActive (tbFiltrByDesgr))
          sAddTitle := sAddTitle + 'ГР.ДЕСКР. ' + '"' + KatSopr.Desgr + '"  ';

        if (BoundActive(tbFiltrByNazna) or BoundActive(tbFiltrByNazna))
          sAddTitle := sAddTitle + 'НАЗНАЧЕНИЕ ' + if(KatSopr.cNazna = 0, '"--"  ', '"' + KatNazna.Name + '"');

              if (BoundActive (tbFiltrGruzToDN) or BoundActive (tbFiltrGruzTo))
                sAddTitle := sAddTitle + 'ГРУЗОПОЛУЧАТЕЛЬ ' + if(KatSopr.cGruzTo = 0, '"--"  ', '"' + KatOrgT.Name + '"  ');

              if (BoundActive (tbFiltrPaymentDN) or BoundActive (tbFiltrPayment))
                sAddTitle := sAddTitle + 'ФОРМА РАСЧЕТА ' + if(KatSopr.cPayment = 0, '"--"  ', '"' + KatPayment.Name + '"  ');

        if (BoundActive (tbFiltrByFPCODN) or BoundActive (tbFiltrByFPCO))
          sAddTitle := sAddTitle + 'ЦО ' + if(KatSopr.cOtvPodr = 0, '"--"  ', '"' + OtvPodr.Name + '"  ');

              if (BoundActive (tbFiltrByKatStroyDN) or BoundActive (tbFiltrByKatStroy))
                sAddTitle := sAddTitle + 'ОБЪЕКТ ' + if(KatSopr.cUks = 0, '"--"  ', '"' + KatStroy.Name + '"  ');

              if (BoundActive (tbFiltrByStatusDN) or BoundActive (tbFiltrByStatus))
                {
                  var strStat : string; strStat := '';

                  case KatSopr.Status of
                    0: strStat := 'Оформляемый';
                    1: strStat := 'Исполняемый';
                    2: strStat := 'Приостановленный';
                    3: strStat := 'Отмененный';
                    4: strStat := 'Закрытый';
                  end;

                  sAddTitle := sAddTitle + 'СТАТУС "' + strStat + '"';
                }
      }

      StopVisual('', 0);
    }

    RunInterface('iCheckTitleKatSopr', TypeSopr, isFilter, BegDate, EndDate, sTitle);
  }

    //проверка записей  **************************************************************
  if (GetLast KatSopr <> tsOk)
    {
      tMyDocFlt         := FALSE;
      set pRecFltDoc.WD := 0;
      isFilter          := FALSE;
      sTitle            := '';
      SetDocBound;

      message('Нет документов удовлетворяющих условиям фильтра.');

      SaveMyDSK(0    , 'Filter_Nakl_Filter_'      + sTypeDoc);
      SaveMyDSK(FALSE, 'Filter_Nakl_bFilterNakl_' + sTypeDoc);
      SaveMyDSK(0    , 'Filter_What_Date_'        + sTypeDoc);

      if GetFirst KatSopr where((tMyRec == KatSopr.Nrec)) = tsOk
        { }  //исходная позиция

      ReReadRecord(#KatSopr);
    }

  if (not tMyDocFlt)
  {
    if BoundActive (tbFiltrByDODN)      SubBounds (tbFiltrByDODN);
    if BoundActive (tbFiltrByDO)        SubBounds (tbFiltrByDO);
    if BoundActive (tbFiltrByDogDN)     SubBounds (tbFiltrByDogDN);
    if BoundActive (tbFiltrByDog)       SubBounds (tbFiltrByDog);
    if BoundActive (tbFiltrByAppDogDN)  SubBounds (tbFiltrByAppDogDN);
    if BoundActive (tbFiltrByAppDog)    SubBounds (tbFiltrByAppDog);
    if BoundActive (tbFiltrByCalPlanDN) SubBounds (tbFiltrByCalPlanDN);
    if BoundActive (tbFiltrByCalPlan)   SubBounds (tbFiltrByCalPlan);
    if BoundActive (tbFiltrByOrgBaseDN) SubBounds (tbFiltrByOrgBaseDN);
    if BoundActive (tbFiltrByOrgBase)   SubBounds (tbFiltrByOrgBase);
    if BoundActive (tbFiltrByDescrDN)   SubBounds (tbFiltrByDescrDN);
    if BoundActive (tbFiltrByDescr)     SubBounds (tbFiltrByDescr);
    if BoundActive (tbFiltrByDesgrDN)   SubBounds (tbFiltrByDesgrDN);
    if BoundActive (tbFiltrByDesgr)     SubBounds (tbFiltrByDesgr);
    if BoundActive (tbFiltrByNazna)     SubBounds (tbFiltrByNazna);
    if BoundActive (tbFiltrByStatusDN)  SubBounds (tbFiltrByStatusDN);
    if BoundActive (tbFiltrByStatus)    SubBounds (tbFiltrByStatus);
    if BoundActive (tbFiltrByFPCODN)    SubBounds (tbFiltrByFPCODN);
    if BoundActive (tbFiltrByFPCO)      SubBounds (tbFiltrByFPCO);
    if BoundActive (tbFiltrByKatStroyDN) SubBounds (tbFiltrByKatStroyDN);
    if BoundActive (tbFiltrByKatStroy)   SubBounds (tbFiltrByKatStroy);

    Rereadrecord(#KatSopr);
    sAddTitle := '';
   }

  SetTitle(if (sTitle = '', strTitle, sTitle) + if(sAddTitle = '', '', ' - ФИЛЬТР:  ' + sAddTitle));

  if ((NOT tMyDocFlt) AND (NOT isFilter))
    {
      RunInterface('iCheckTitleKatSopr', TypeSopr, FALSE, ZeroDate, ZeroDate, sTitle);
      SetTitle(sTitle);
    }

  HidePickButton;

  ReReadRecord(#KatSopr);
}
