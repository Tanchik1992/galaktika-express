//********************************************************************************
//                                                        (c) корпорация Галактика
// Галактика 7.12 - _
// _
//********************************************************************************

!╔═══════════════════════════════════════════════════════════════════════════╗
!║ Назначение    : Тело ф-ции RefreshNalogs                                  ║
!╚═══════════════════════════════════════════════════════════════════════════╝

if not OtkatToOldState(false, word(0))
  continue;

oldsumma  := KatSopr.Summa;
oldvsumma := KatSopr.SumVal;

isObor := GetFirst Oborot
                where ((KatSopr.VidSopr == Oborot.TiDk AND
                           KatSopr.NRec == Oborot.cSoprDoc)) = tsOk;
if (KatSopr.wAdoc = adSoprDocSN)
  {
    frm1wed.Write('Документ '+ NomDes + ' от ' +
                   string(KatSopr.dSopr) +
                  ' сторнирует информацию за прошлый период. Документ пропущен.');
    aReported := aReported or TRUE;
    continue;
  }

if (((opts AND 1) <> 0) AND isObor)
  {
    if ((opts AND 16) <> 0)
      {
        frm1wed.Write('По документу '+ NomDes + ' от ' +
                      string(KatSopr.dSopr) +
                      ' были сформированы проводки. Документ пропущен.');
        aReported := aReported or TRUE;
      }
    continue;
  }

if (((opts AND 4) <> 0) AND (longint(KatSopr.dOpr) <> 0))
  {
    if ((opts AND 16) <> 0)
      {
        frm1wed.Write('В документе '+ NomDes + ' от ' +
                      string(KatSopr.dSopr) +
                      ' установлена дата проведения. Документ пропущен.');
        aReported := aReported or TRUE;
      }
    continue;
  }
if (isObor)
  {
    frm1wed.Write('По документу '+ NomDes + ' от ' + string(KatSopr.dSopr) +
                  ' были сформированы проводки. Их нужно проверить.');
    aReported := aReported or TRUE;
  }

if ((opts AND 32) <> 0)
  _LOOP SpSopr
      if (SpSopr.ManualTax = 0)
          Delete NoVisual SpDocNal
           where ((SpSopr.NRec == SpDocNal.cSpDoc AND
                      TypeSopr == SpDocNal.TipDoc));

   if not NextVisual Break;
   CheckSumma(true);

if ((opts AND 8) <> 0)
  if ((oldsumma <> KatSopr.Summa) or (oldvsumma <> KatSopr.SumVal))
    {
      aReported := aReported or TRUE;
      frm1wed.Write('Сумма по документу ' + NomDes + ' от '+
                     string(KatSopr.dSopr)+ ' изменена: ');
      if (oldsumma <> KatSopr.Summa)
        frm1wed.Write('     НДЕ было: ' + DoubleToStr(oldsumma, '\2P[|-]3666666666666666.88') +
                             ' стало: ' + DoubleToStr(KatSopr.Summa, '\2P[|-]3666666666666666.88'));
      if (oldvsumma <> KatSopr.SumVal)
        frm1wed.Write('     '+ KlVal.SimvolV+' было: '+
                      DoubleToStr(oldvsumma, '\2P[|-]3666666666666666.88') + ' стало: ' +
                      DoubleToStr(KatSopr.SumVal, '\2P[|-]3666666666666666.88'));
    }
