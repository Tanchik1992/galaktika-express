!ษอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออป
!บ งญ็ฅญจฅ    : เฎๆฅคใเ๋ ฎกเกฎโชจ คซ๏ ฏเจๅฎคญ๋ๅ ญชซคญ๋ๅ               บ
!ศอออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผ
procedure PrevSopUsl(var RPr:double;var VPr:double);
var 
  AllPrice,
  AllVPrice : double;
  acStepDoc : comp;
  FoundSopr : boolean;
{
  AllPrice  := 0;
  AllVPrice := 0;
  acStepDoc := KatSopr.cStepDoc;

  PushPos(#KatSopr);
  PushPos(#SpSopr);
  _LOOP KatSopr where ((acStepDoc == KatSopr.cStepDoc))
    _LOOP SpSopr where ((KatSopr.NRec == SpSopr.cSopr   and
                         SpStep.cMCUsl == SpSopr.cMCUsl and
                         SpStep.PrMC == SpSopr.PrMc))
      {
        FoundSopr := SpSopr.cSpStep = SpStep.NRec;
        if (not FoundSopr) 
          if (SpSopr.cSpStep <> 0)
            Continue;
        if (FoundSopr)
          {
            AllPrice := AllPrice + SpSopr.Price;
            AllVPrice := AllPrice + SpSopr.VPrice;
          }
      }
  PopPos(#SpSopr);
  PopPos(#KatSopr);
  RPr := AllPrice;
  VPr := AllVPrice;
}

// กเกฎโช ขแโขชจ ข ฏเจๅฎคญใ๎ ญชซคญใ๎ แฎฏใโแขใ๎้จๅ ใแซใฃ ฏฎ 
function AdvansedInsMC(Curse : double) : boolean;
var sPrice : double;
{
  AdvansedInsMc := SpSopr.PrMC <> 2;
  if (SpStep.PrMc <= 2)
    {
      SpSopr.PrMC := SpStep.PrMC;
      exit;
    }

  AdvansedInsMC := true;
  SpSopr.PrMC := SpStep.PrMC;
  sPrice := SpStep.Summa / SpStep.Kol;
  Case SpStep.PrMC of
   3 :
    {
      SpSopr.Kol := SpStep.kolSkl; SpSopr.KolFact := SpStep.KolSkl;
      SpSopr.KolOpl := SpStep.KolSkl;
    }
   4,5,6 :
    { var PrevR,PrevV : double;
      PrevSopUsl(PrevR,PrevV);
      Case BaseDoc.TipMoney of
        1 :
          {
            SpSopr.Price := sPrice * SpStep.Kol - PrevR;
            If (coGetTune('BaseCurrency')=0) 
              SpSopr.VPrice := 0//ฎก้ฅแจแโฅฌญ๏ ญแโเฎฉช=กงฎข๏ ขซ๎โ 
            else                   
              SpSopr.VPrice := (sPrice * SpStep.Kol - PrevR) / Curse;
            if (SpSopr.Price = 0.0) //ฏจเ 101.9705 if (SpSopr.Price <= 0.0) 
                AdvansedInsMC := false;
          }
        2,3 :
          {
            SpSopr.VPrice := sPrice * SpStep.Kol - PrevV;
            SpSopr.Price := (sPrice  * SpStep.Kol - PrevV ) * curse;
            if (SpSopr.Price = 0.0) //ฏจเ 101.9705  if (SpSopr.VPrice <= 0.0)
                AdvansedInsMC := false;
          }
      end;
    }
  end;
}

#include stdprb.vpp
