!╔═══════════════════════════════════════════════════════════════════════════╗
!║                     (c) 1994,98 корпорация ГАЛАКТИКА                      ║
!║ Проект        : ГАЛАКТИКА                                                 ║
!║ Система       : Оперативный контур                                        ║
!║ Версия        : 5.70                                                      ║
!║ Назначение    : Функции для пакетного форм-ния накладных по расп на отгр  ║
!║ Ответственный : Лебедев Сергей Владимирович                               ║
!║ Параметры     :                                                           ║
!╚═══════════════════════════════════════════════════════════════════════════╝

Function FSRoundRub(Value : double) : double;
{
  Case KatSopr.VidSopr of
    101, 108, 111, 206 : FSRoundRub := FRoundRub1(Value);
    102, 202 : FSRoundRub := FRoundRub4(Value);
    103, 203 : FSRoundRub := FRoundRub3(Value);
    106, 201, 204, 205, 211, 510, 513, 521, 522,
    523, 550, 553, 554, 557 : FSRoundRub := FRoundRub2(Value);
    501..506,511,512,551,552, 600,601,602,603,
    611,612,621,622 : FSRoundRub := Value;
    else
      { Message(''#3'Округление: Неизвестный тип документа: '+
                        string(KatSopr.VidSopr), Error + OkButton);
        FSRoundRub := Value;
      }
  end;
}


// Округление валютных величин
Function FSRoundVal(Value : double) : double;
{
  Case KatSopr.VidSopr of
    101, 108, 111, 206 : FSRoundVal := FRoundVal1(Value);

    102, 202 : FSRoundVal := FRoundVal4(Value);

    103, 203 : FSRoundVal := FRoundVal3(Value);

    106, 201,204,205,211, 510, 513,521,522,
    523,550,553, 554, 557 : FSRoundVal := FRoundVal2(Value);

    501..506,511,512, 551,552,600,601,602,603,
    624,625,
    611,612,621,622 : FSRoundVal := Value;
   else { Message(''#3'Округление: Неизвестный тип документа: '+
                  string(KatSopr.VidSopr), Error + OkButton);
          FSRoundVal := Value;
        }
  end;
}


//-----Обычный пересчет сумм по накладной-----------
/*procedure RecalcSumm(UpdSpSopr : boolean); //не исп-ся
{
 if (not UpdSpSopr) if (not UpdateTable) Exit;
 PushPos(#SpSopr);
 KatSopr.Summa := 0;   KatSopr.SumVal := 0;
 KatSopr.sNalogs := 0; KatSopr.svNalogs := 0;
 ResetBounds(#SpSopr);
 if (GetFirst SpSopr where ((KatSopr.NRec == SpSopr.cSopr)) = tsOk) {
  do {
   KatSopr.sNalogs := KatSopr.sNalogs + SpSopr.SumNDS;
   KatSopr.svNalogs := KatSopr.svNalogs + SpSopr.SumVNDS;
   KatSopr.Summa := KatSopr.Summa + SpSopr.Price * SpSopr.KolOpl;
   KatSopr.SumVal := KatSopr.SumVal + SpSopr.VPrice * SpSopr.KolOpl;
   if (UpdSpSopr) {
    if ((SpSopr.cVal <> KatSopr.cValut) or (SpSopr.dOprTTN <> KatSopr.dOpr) or
     (SpSopr.dSopr <> KatSopr.dSopr)) {
     SpSopr.cVal := KatSopr.cValut;  SpSopr.dOprTTN := KatSopr.dOpr;
     SpSopr.dSopr := KatSopr.dSopr;
     update current SpSopr;
    }
   }
  } while (GetNext SpSopr where ((KatSopr.NRec == SpSopr.cSopr)) = tsOk);
  if (KatSopr.VhodNal <> 1) {
   KatSopr.Summa  := FSRoundRub(KatSopr.Summa + KatSopr.sNalogs);
   KatSopr.SumVal := FSRoundVal(KatSopr.SumVal + KatSopr.svNalogs);
  } else {
   KatSopr.Summa  := FSRoundRub(KatSopr.Summa);
   KatSopr.SumVal := FSRoundVal(KatSopr.SumVal);
  }
 }
 SetBounds(#SpSopr);
 PopPos(#SpSopr);
 if GetFirst TTNDoc=tsOk
   KatSopr.Summa := KatSopr.Summa + TTNDoc.sumAvt;//+KatSopr.TTNsumUSL;
}*/


//-------------------------------------------------------------------------
procedure RecalcNalogs(aGrNal: comp; chGrNal: comp);
var vaGrNal  : comp;
var WDate    : date;
{
  if (SpSopr.ManualTax <> 0)
    Exit; // Если налоги ручные, то выход...

  if (longint(KatSopr.dPrice) <> 0)
    WDate := KatSopr.dPrice
  else
    WDate := KatSopr.dSopr;

  ResetBounds(#SpDocNal);
  if (chGrNal = 0)
    {
      if (GetFirst SpDocNal
                  Where ((SpSopr.NRec == SpDocNal.cSpDoc and
       KatSopr.VidSopr == SpDocNal.TipDoc)) = tsOk)
        if (SpDocNal.cGrNal <> 0)
          vaGrNal := SpDocNal.cGrNal
        else
          vaGrNal := aGrNal;
      else
        vaGrNal := aGrNal;
    }
  else
    vaGrNal := chGrNal;

  SetBounds(#SpDocNal);
  InitNalServ;
  if (KatSopr.VhodNal = 1)
    {
      CountBasePrice(KatSopr.NRec, SpSopr.NRec, KatSopr.VidSopr, vaGrNal,
       KatSopr.cOrgBase, SpSopr.KolFact, SpSopr.cOtpEd, WDate,
       KatSopr.cValut, 0, SpSopr.Price * SpSopr.KolOpl, SpSopr.VPrice * SpSopr.KolOpl,
       KatSopr.cPayment );
       SpSopr.SumNDS := (SpSopr.Price * SpSopr.KolOpl) - GetBasePrice;
       set SpSopr.SumVNDS := (SpSopr.VPrice * SpSopr.KolOpl) - GetBaseValPrice;
    }
  else
    {
      CountNalogPrice(KatSopr.NRec, SpSopr.NRec, KatSopr.VidSopr, vaGrNal,
       KatSopr.cOrgBase, SpSopr.KolFact, SpSopr.cOtpEd, WDate,
       KatSopr.cValut, 0, SpSopr.Price * SpSopr.KolOpl, SpSopr.VPrice * SpSopr.KolOpl,
       KatSopr.cPayment );
       SpSopr.SumNDS := GetNalogPrice - (SpSopr.Price * SpSopr.KolOpl);
       SpSopr.SumVNDS := GetNalogValPrice - (SpSopr.VPrice * SpSopr.KolOpl);
    }
  DoneNalServ;
}


//---------------------------------------------------
function CanPickRO(showMess_:boolean): boolean;
var ExistDoc: boolean;
begin
CanPickRO:=true;
ExistDoc  :=false;

if isValid(#KatSopr)  ExistDoc:=true;
CanPickRO:=not ExistDoc;

if showMess_
 if ExistDoc
   if message(''#3'По данному распоряжению уже была формирована'#13#3+
              'накладная(накладные).'#13#3+
              'Пометить документ для формирования ?',YesNo) =Yes
     CanPickRO:=true;
end;//f


//------------------------------------
procedure AddProtocol(var first_:boolean);
begin
if first_
 { prot.write('Распоряжение на отгрузку № '+OtgOrder.NoDoc+' от '+DateToStr(OtgOrder.dDoc,'DD/MM/YYYY'));
   first_:=false;
 }
if KatSopr.cVal<>0  If GetFirst KlVal where ((KatSopr.cVal == KlVal.nRec)) <>tsOK {};
prot.write('Наряд-заказ № '+NZakaz.NoDoc+' от '+DateToStr(NZakaz.dDoc,'DD/MM/YYYY'));
prot.write(' -сформирована накладная № '+KatSopr.NSopr+' от '+DateToStr(KatSopr.dSopr,'DD/MM/YYYY')+
           ' (отпуск), на сумму '+
           if (KatSopr.cVal=0,string(KatSopr.summa),string(KatSopr.sumVal))+' '+
           if (KatSopr.cVal=0, sGetTune('NDE.SimvRub'), KlVal.SimVolV)  );
end;

