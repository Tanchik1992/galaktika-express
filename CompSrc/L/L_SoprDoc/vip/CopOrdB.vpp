//╔═════════════════════════════════════════════════════════════════════╗
//║          Галактика (с) 1995, TOP SOFT Ltd., Новый АТЛАНТ            ║
//║  Версия    :  5.50                                                  ║
//║  Разработал:  Голец Д.И. (dig)                                      ║
//║  Назначение:  Пересортировка накладной по МЦ                        ║
//║  Изменения :                                                        ║
//╚═════════════════════════════════════════════════════════════════════╝

Procedure CopySoprOrdB(oldSpSopr:comp);
{
   StartNewVisual(vtIndicatorVisual, vfTimer+vfBreak+vfConfirm,
    ''#3'Копируем разрез хранения матценности...'#13#3, RecordsInTable(#SoprOrdB));
// проверяем если разрез хранения в опер контуре, то копируем их для новой
    ResetBounds(#SoprOrdB);
    if (GetFirst SoprOrdB where ((oldSpSopr == SoprOrdB.cSpSopr )) = tsOk) do {
      PushPos(#SoprOrdB);
      if (not NextVisual) BREAK;
      set SoprOrdB.cSpSopr := SpSopr.Nrec;
      if (update current SoprOrdB <> tsOk)
        message(''#3'Ошибка копирования разреза хранения матценности',CancelButton);
      PopPos(#SoprOrdB);
!    } while (GetNext SoprOrdB where ((oldSpSopr == SoprOrdB.cSpSopr)) = tsOk);
    } while (GetFirst SoprOrdB where ((oldSpSopr == SoprOrdB.cSpSopr)) = tsOk);
    SetBounds(#SoprOrdB);
    StopVisual('',0);   // скопировали разрез хранения
}

Create view loUpDtSpOrder
select
  SpOrder.*
from
  SpOrder;

//-- модификация ссылки на спецификацию накладной в складском ордере
Procedure UpDateSpOrder(oldSpSopr:comp);
var ret:word;
{
   StartNewVisual(vtIndicatorVisual, vfTimer+vfBreak,
    ''#3'Модифицируем складские ордера...',0);
// проверяем если разрез хранения в опер контуре, то копируем их для новой

    for (ret:=loUpDtSpOrder.GetFirst SpOrder where ((oldSpSopr == SpOrder.cSpSopr ));
         ret = tsOk;
         ret:=loUpDtSpOrder.GetFirst SpOrder where ((oldSpSopr == SpOrder.cSpSopr ))
        )
      {
        PushPos(loUpDtSpOrder.tnSpOrder);
        if (not NextVisual) BREAK;
        set loUpDtSpOrder.SpOrder.cSpSopr := SpSopr.Nrec;
        if (loUpDtSpOrder.update current SpOrder <> tsOk)
          message(''#3'Ошибка модификации спецификации ордера',CancelButton);
        PopPos(loUpDtSpOrder.tnSpOrder);
      }
    StopVisual('',0);   // скопировали разрез хранения
}

